name: Ansible AdGuard Home Install

# ==========================================
# トリガー
# ==========================================
on:
  # Ansible ファイル変更時に実行
  push:
    branches:
      - main
    paths:
      - 'ansible/playbook-adguard-home-install.yml'
      - 'ansible/inventory.yml'
      - '.github/workflows/ansible-adguard-home-install.yml'

  # 手動トリガー
  workflow_dispatch:

jobs:
  # =========================================
  # AdGuard Home インストール
  # =========================================
  deploy:
    name: Deploy - AdGuard Home Install
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 30

    env:
      ANSIBLE_WORK_DIR: ./ansible

    defaults:
      run:
        working-directory: ${{ env.ANSIBLE_WORK_DIR }}

    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4

      - name: Python 3.11 をセットアップ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: '**/requirements.txt'

      - name: Python 依存パッケージをインストール
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ansible ロールをインストール
        run: |
          mkdir -p roles
          ansible-galaxy install -r requirements.yml -p roles -f

      - name: SSH キーをセットアップ
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "${{ secrets.ANSIBLE_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 192.168.0.30 >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: ホストへの接続テスト
        run: |
          ansible adguard_home -i inventory.yml -m ping

      - name: Ansible 構文チェック
        run: |
          ansible-playbook -i inventory.yml playbook-adguard-home-install.yml --syntax-check

      - name: AdGuard Home インストール（ドライラン）
        run: |
          ansible-playbook -i inventory.yml playbook-adguard-home-install.yml --check

      - name: AdGuard Home インストール（本番）
        run: |
          ansible-playbook -i inventory.yml playbook-adguard-home-install.yml

      - name: インストール完了
        if: always()
        run: |
          echo "## AdGuard Home インストール完了"
          echo "- URL: http://192.168.0.30:3000"
          echo "- DNS Server: 192.168.0.30:53"
          echo "- Timestamp: $(date)"
