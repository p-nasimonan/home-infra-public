name: Ansible Deploy

# ==========================================
# ãƒˆãƒªã‚¬ãƒ¼
# ==========================================
on:
  # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ã®ã¿
  workflow_dispatch:
    inputs:
      playbook:
        description: 'å®Ÿè¡Œã™ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ–ãƒƒã‚¯'
        required: true
        type: choice
        options:
          - playbook-k3s-setup.yml
          - playbook-k3s-uninstall.yml
          - playbook-adguard-home-install.yml
          - playbook-argocd-install.yml
          - playbook-check-kubevip.yml
      tags:
        description: 'å®Ÿè¡Œã™ã‚‹ã‚¿ã‚° (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã€ç©ºç™½ã§ã‚¹ã‚­ãƒƒãƒ—)'
        required: false
        type: string
        default: ''

# å®Ÿè¡Œæ™‚ã«é¸æŠã—ãŸãƒ—ãƒ¬ã‚¤ãƒ–ãƒƒã‚¯åã‚’è¡¨ç¤º
run-name: "Ansible Deploy - ${{ github.event.inputs.playbook }} tag:${{ github.event.inputs.tags }}"

jobs:
  # =========================================
  # å…±é€šã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¸ãƒ§ãƒ–
  # =========================================
  setup:
    name: Setup Environment
    runs-on: [self-hosted, Linux, X64]
    outputs:
      playbook_name: ${{ steps.set-vars.outputs.playbook_name }}
      hosts: ${{ steps.set-vars.outputs.hosts }}
      timeout: ${{ steps.set-vars.outputs.timeout }}
    steps:
      - name: ãƒ—ãƒ¬ã‚¤ãƒ–ãƒƒã‚¯å¤‰æ•°ã‚’è¨­å®š
        id: set-vars
        run: |
          case "${{ github.event.inputs.playbook }}" in
            playbook-k3s-setup.yml)
              echo "playbook_name=Deploy - K3s & Rancher" >> $GITHUB_OUTPUT
              echo "hosts=k3s_servers k3s_workers" >> $GITHUB_OUTPUT
              echo "timeout=180" >> $GITHUB_OUTPUT
              ;;
            playbook-k3s-uninstall.yml)
              echo "playbook_name=Uninstall - K3s Cluster" >> $GITHUB_OUTPUT
              echo "hosts=k3s_servers k3s_workers" >> $GITHUB_OUTPUT
              echo "timeout=60" >> $GITHUB_OUTPUT
              ;;
            playbook-adguard-home-install.yml)
              echo "playbook_name=Deploy - AdGuard Home" >> $GITHUB_OUTPUT
              echo "hosts=adguard_home" >> $GITHUB_OUTPUT
              echo "timeout=30" >> $GITHUB_OUTPUT
              ;;
            playbook-argocd-install.yml)
              echo "playbook_name=Deploy - ArgoCD" >> $GITHUB_OUTPUT
              echo "hosts=k3s_servers" >> $GITHUB_OUTPUT
              echo "timeout=60" >> $GITHUB_OUTPUT
              ;;
            playbook-check-kubevip.yml)
              echo "playbook_name=Check - kube-vip VIP Status" >> $GITHUB_OUTPUT
              echo "hosts=k3s_servers" >> $GITHUB_OUTPUT
              echo "timeout=15" >> $GITHUB_OUTPUT
              ;;
          esac

  # =========================================
  # Ansible å®Ÿè¡Œã‚¸ãƒ§ãƒ–
  # =========================================
  deploy:
    name: ${{ needs.setup.outputs.playbook_name }}
    needs: setup
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: ${{ fromJson(needs.setup.outputs.timeout) }}

    env:
      ANSIBLE_WORK_DIR: ./ansible
      PLAYBOOK_FILE: ${{ github.event.inputs.playbook }}

    defaults:
      run:
        working-directory: ${{ env.ANSIBLE_WORK_DIR }}

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Python 3.11 ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: '**/requirements.txt'

      - name: Python ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ansible ãƒ­ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        if: ${{ github.event.inputs.playbook == 'playbook-k3s-setup.yml' || github.event.inputs.playbook == 'playbook-k3s-uninstall.yml' }}
        run: |
          mkdir -p roles
          ansible-galaxy install -r requirements.yml -p roles -f

      - name: SSH ã‚­ãƒ¼ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "${{ secrets.ANSIBLE_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 192.168.0.20 192.168.0.21 192.168.0.22 192.168.0.23 192.168.0.24 192.168.0.30 >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: SSH æ¥ç¶šãƒ†ã‚¹ãƒˆ
        run: |
          ansible all -i inventory.yml -m ping

      - name: Ansible æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
        run: |
          ansible-playbook -i inventory.yml "${{ env.PLAYBOOK_FILE }}" --syntax-check

      - name: Ansible ãƒ—ãƒ¬ã‚¤ãƒ–ãƒƒã‚¯å®Ÿè¡Œ
        env:
          RANCHER_PASSWORD: ${{ secrets.RANCHER_PASSWORD }}
          ARGOCD_GITHUB_CLIENT_ID: ${{ secrets.ARGOCD_GITHUB_CLIENT_ID }}
          ARGOCD_GITHUB_CLIENT_SECRET: ${{ secrets.ARGOCD_GITHUB_CLIENT_SECRET }}
          CLOUDFLARE_TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
        run: |
          # ArgoCDç”¨ã®è¿½åŠ å¼•æ•°ã‚’è¨­å®š
          EXTRA_ARGS=""
          if [[ "${{ env.PLAYBOOK_FILE }}" == "playbook-argocd-install.yml" ]]; then
            EXTRA_ARGS="-e github_client_id=${ARGOCD_GITHUB_CLIENT_ID} -e github_client_secret=${ARGOCD_GITHUB_CLIENT_SECRET} -e github_admin_username=${{ github.actor }}"
          fi
          
          # ã‚¿ã‚°ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯è¿½åŠ 
          if [[ -n "${{ github.event.inputs.tags }}" ]]; then
            EXTRA_ARGS="${EXTRA_ARGS} --tags ${{ github.event.inputs.tags }}"
          fi
          
          ansible-playbook -i inventory.yml "${{ env.PLAYBOOK_FILE }}" -v ${EXTRA_ARGS}

      - name: å®Ÿè¡Œå®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        if: success()
        run: |
          PLAYBOOK="${{ env.PLAYBOOK_FILE }}"
          case "$PLAYBOOK" in
            playbook-k3s-setup.yml)
              echo "âœ… K3s & Rancher ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ"
              echo "ğŸ“ API: https://192.168.0.200:6443"
              echo "ğŸ“ Web UI: https://rancher.youkan.uk"
              ;;
            playbook-k3s-uninstall.yml)
              echo "âœ… K3s ã‚¯ãƒ©ã‚¹ã‚¿ã‚’ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ãŸ"
              echo "âš ï¸  ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ"
              ;;
            playbook-adguard-home-install.yml)
              echo "âœ… AdGuard Home ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"
              echo "ğŸ“ URL: http://192.168.0.30:3000"
              echo "ğŸ“ DNS Server: 192.168.0.30:53"
              ;;
            playbook-argocd-install.yml)
              echo "âœ… ArgoCD ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"
              echo "ğŸ“ URL: https://argocd.youkan.uk"
              echo "ğŸ“ GitHub SSO: æœ‰åŠ¹"
              ;;
            playbook-check-kubevip.yml)
              echo "âœ… kube-vip VIP ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªå®Œäº†"
              echo "ğŸ“ VIP: 192.168.0.200"
              ;;
          esac
          
          # Cloudflare Tunnel ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
          if grep -q "cloudflare" "${{ env.PLAYBOOK_FILE }}"; then
            echo ""
            echo "ğŸ“ Cloudflare Tunnel: https://one.dash.cloudflare.com"
          fi

      - name: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¡¨ç¤º
        if: failure()
        run: |
          echo "âŒ ãƒ—ãƒ¬ã‚¤ãƒ–ãƒƒã‚¯å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ"
          echo "è©³ç´°ã¯ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"

