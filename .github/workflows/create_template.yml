name: Create Template VM

on:
  workflow_dispatch:
    inputs:
      action:
        description: "実行するアクション"
        required: true
        default: "verify"
        type: choice
        options:
          - verify
          - convert

jobs:
  create_template:
    name: Create Template VM
    runs-on: [self-hosted, Linux, X64]
    
    env:
      PROXMOX_HOST: 192.168.0.8
      TEMPLATE_VMID: 9000

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # =============================================
      # Verify: テンプレート VM が起動確認
      # =============================================
      - name: テンプレート VM の起動確認
        if: ${{ github.event.inputs.action == 'verify' }}
        run: |
          echo "=== Template VM VMID: $TEMPLATE_VMID を確認 ==="
          ssh -o StrictHostKeyChecking=no root@${{ env.PROXMOX_HOST }} "qm status $TEMPLATE_VMID"
          
          echo ""
          echo "=== テンプレート VM を起動 ==="
          ssh -o StrictHostKeyChecking=no root@${{ env.PROXMOX_HOST }} "qm start $TEMPLATE_VMID || true"
          echo "起動待機中... (30秒)"
          sleep 30

      - name: テンプレート VM に SSH 接続テスト
        if: ${{ github.event.inputs.action == 'verify' }}
        run: |
          echo "=== SSH 接続テスト (IP: 10.0.0.100) ==="
          
          for i in {1..20}; do
            if ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no ubuntu@10.0.0.100 "echo 'SSH接続成功'" 2>/dev/null; then
              echo "✓ SSH 接続成功"
              break
            fi
            if [ $i -eq 20 ]; then
              echo "::error:: SSH 接続に失敗（20回試行後）"
              exit 1
            fi
            echo "試行 $i/20: 接続待機中..."
            sleep 3
          done

      - name: テンプレート VM システム情報確認
        if: ${{ github.event.inputs.action == 'verify' }}
        run: |
          echo "=== システム情報 ==="
          ssh -o StrictHostKeyChecking=no ubuntu@10.0.0.100 "uname -a"
          ssh -o StrictHostKeyChecking=no ubuntu@10.0.0.100 "hostname"
          ssh -o StrictHostKeyChecking=no ubuntu@10.0.0.100 "ip addr show"
          
          echo ""
          echo "=== Docker インストール確認 ==="
          ssh -o StrictHostKeyChecking=no ubuntu@10.0.0.100 "docker --version 2>/dev/null || echo 'Docker未インストール'"

      - name: テンプレート VM を停止
        if: ${{ github.event.inputs.action == 'verify' && always() }}
        run: |
          echo "=== テンプレート VM を停止 ==="
          ssh -o StrictHostKeyChecking=no root@${{ env.PROXMOX_HOST }} "qm stop $TEMPLATE_VMID || true"
          sleep 5

      # =============================================
      # Convert: 既存 VM をテンプレート化
      # =============================================
      - name: テンプレート化（VM → Template）
        if: ${{ github.event.inputs.action == 'convert' }}
        run: |
          echo "=== VM $TEMPLATE_VMID をテンプレート化 ==="
          
          # 1. VM が起動している場合は停止
          STATUS=$(ssh -o StrictHostKeyChecking=no root@${{ env.PROXMOX_HOST }} "qm status $TEMPLATE_VMID" | awk '{print $2}')
          if [ "$STATUS" = "running" ]; then
            echo "VM を停止中..."
            ssh -o StrictHostKeyChecking=no root@${{ env.PROXMOX_HOST }} "qm stop $TEMPLATE_VMID"
            sleep 5
          fi
          
          # 2. テンプレート化
          echo "テンプレート化処理を実行中..."
          ssh -o StrictHostKeyChecking=no root@${{ env.PROXMOX_HOST }} "qm template $TEMPLATE_VMID"
          
          echo "✓ テンプレート化完了"

      - name: テンプレート化確認
        if: ${{ github.event.inputs.action == 'convert' }}
        run: |
          echo "=== テンプレート一覧 ==="
          ssh -o StrictHostKeyChecking=no root@${{ env.PROXMOX_HOST }} "qm list | grep template || qm list"

      # =============================================
      # Summary
      # =============================================
      - name: 実行結果サマリー
        if: always()
        run: |
          echo "## Template VM 処理結果" >> $GITHUB_STEP_SUMMARY
          echo "- アクション: ${{ github.event.inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "- Template VMID: $TEMPLATE_VMID" >> $GITHUB_STEP_SUMMARY
          echo "- ステータス: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
