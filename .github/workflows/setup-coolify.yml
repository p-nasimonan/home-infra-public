name: Coolify セットアップ自動化

on:
  workflow_dispatch:
    inputs:
      action:
        description: "実行するアクション"
        required: true
        default: "setup"
        type: choice
        options:
          - setup
          - destroy
          - verify

jobs:
  coolify-setup:
    runs-on: self-hosted  # infra-runner で実行
    steps:
      # =============================================
      # 1. リポジトリをチェックアウト
      # =============================================
      - name: チェックアウト
        uses: actions/checkout@v4

      # =============================================
      # 1.5. Terraform 環境変数を設定
      # =============================================
      - name: Terraform 環境変数を設定
        if: ${{ github.event.inputs.action == 'setup' || github.event.inputs.action == 'destroy' }}
        run: |
          echo "TF_VAR_cloudflare_api_token=${{ secrets.CLOUDFLARE_API_TOKEN }}" >> $GITHUB_ENV
          echo "TF_VAR_proxmox_token_id=${{ secrets.PROXMOX_TOKEN_ID }}" >> $GITHUB_ENV
          echo "TF_VAR_proxmox_token_secret=${{ secrets.PROXMOX_TOKEN_SECRET }}" >> $GITHUB_ENV
          echo "TF_API_TOKEN=${{ secrets.TF_API_TOKEN }}" >> $GITHUB_ENV

      # =============================================
      # 2. Terraform 初期化と情報取得
      # =============================================
      - name: Terraform 初期化
        if: ${{ github.event.inputs.action == 'setup' || github.event.inputs.action == 'destroy' }}
        run: |
          cd ${{ github.workspace }}
          terraform init

      - name: monaka node ホスト名を設定
        if: ${{ github.event.inputs.action == 'setup' }}
        run: |
          # monaka.youkan.uk をホスト名で使用
          echo "MONAKA_HOST=monaka.youkan.uk" >> $GITHUB_ENV
          echo "monaka host: monaka.youkan.uk"

      # =============================================
      # 3. SSH キーを設定（Proxmox アクセス用）
      # =============================================
      - name: SSH キーを設定
        if: ${{ github.event.inputs.action == 'setup' }}
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PROXMOX_SSH_KEY }}" > ~/.ssh/proxmox_key
          chmod 600 ~/.ssh/proxmox_key
          ssh-keyscan -t rsa ${{ env.MONAKA_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      # =============================================
      # 4. クラウドイメージをダウンロード（初回のみ）
      # =============================================
      - name: クラウドイメージをダウンロード
        if: ${{ github.event.inputs.action == 'setup' }}
        run: |
          ssh -i ~/.ssh/proxmox_key root@${{ env.MONAKA_HOST }} << 'EOF'
          set -e
          mkdir -p /var/lib/vz/template/iso
          if [ ! -f /var/lib/vz/template/iso/jammy-server-cloudimg-amd64.img ]; then
            echo "クラウドイメージをダウンロード中..."
            cd /var/lib/vz/template/iso
            wget -q https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img
            echo "ダウンロード完了"
          else
            echo "クラウドイメージは既に存在します"
          fi
          EOF

      # =============================================
      # 4.5. cloud-init 設定ファイルを Proxmox に配置
      # =============================================
      - name: cloud-init ファイルを Proxmox に配置
        if: ${{ github.event.inputs.action == 'setup' }}
        run: |
          ssh -i ~/.ssh/proxmox_key root@${{ env.MONAKA_HOST }} << 'EOF'
          set -e
          mkdir -p /var/lib/vz/snippets
          
          # cloud-init ファイルを作成
          cat > /var/lib/vz/snippets/coolify-init.yaml << 'CLOUDINIT'
          #cloud-config
          package_update: true
          packages:
            - openssh-server
            - qemu-guest-agent
          ssh_pwauth: true
          disable_root: false
          CLOUDINIT
          
          chmod 644 /var/lib/vz/snippets/coolify-init.yaml
          echo "✓ cloud-init ファイルを配置しました"
          ls -lh /var/lib/vz/snippets/coolify-init.yaml
          EOF

      # =============================================
      # 5. Terraform Plan（確認）
      # =============================================
      - name: Terraform Plan
        if: ${{ github.event.inputs.action == 'setup' }}
        run: |
          cd ${{ github.workspace }}
          terraform plan -target=proxmox_virtual_environment_vm.coolify -out=tfplan

      # =============================================
      # 6. Terraform Apply（VM 作成）
      # =============================================
      - name: Terraform Apply
        if: ${{ github.event.inputs.action == 'setup' }}
        run: |
          cd ${{ github.workspace }}
          terraform apply -target=proxmox_virtual_environment_vm.coolify -auto-approve

      # =============================================
      # 7. VM の IP を取得
      # =============================================
      - name: VM の IP を取得
        if: ${{ github.event.inputs.action == 'setup' }}
        run: |
          cd ${{ github.workspace }}
          COOLIFY_IP=$(terraform output -raw coolify_vm_ip)
          echo "COOLIFY_IP=$COOLIFY_IP" >> $GITHUB_ENV
          echo "VM の IP: $COOLIFY_IP"

      # =============================================
      # 8. VM の起動を待機
      # =============================================
      - name: VM の起動を待機（60秒）
        if: ${{ github.event.inputs.action == 'setup' }}
        run: sleep 60

      # =============================================
      # 9. SSH 接続テスト
      # =============================================
      - name: SSH 接続テスト
        if: ${{ github.event.inputs.action == 'setup' }}
        run: |
          for i in {1..10}; do
            if ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no ubuntu@${{ env.COOLIFY_IP }} "echo 'SSH OK'" 2>/dev/null; then
              echo "✓ SSH 接続成功"
              exit 0
            else
              echo "接続試行 $i/10 失敗、再試行..."
              sleep 10
            fi
          done
          echo "✗ SSH 接続失敗"
          exit 1

      # =============================================
      # 10. Ansible Inventory の確認
      # =============================================
      - name: Ansible Inventory の確認
        if: ${{ github.event.inputs.action == 'setup' }}
        run: |
          cd ${{ github.workspace }}/ansible
          cat inventory.ini
          echo ""
          echo "Inventory の内容を確認："
          ansible-inventory -i inventory.ini --list

      # =============================================
      # 11. Ansible Ping テスト
      # =============================================
      - name: Ansible Ping テスト
        if: ${{ github.event.inputs.action == 'setup' }}
        run: |
          cd ${{ github.workspace }}/ansible
          ansible all -i inventory.ini -m ping -v

      # =============================================
      # 12. Ansible Playbook 実行
      # =============================================
      - name: Ansible で Coolify をインストール
        if: ${{ github.event.inputs.action == 'setup' }}
        run: |
          cd ${{ github.workspace }}/ansible
          ansible-playbook -i inventory.ini playbook-coolify.yml -v

      # =============================================
      # 13. インストール確認
      # =============================================
      - name: Docker / Coolify ステータス確認
        if: ${{ github.event.inputs.action == 'setup' }}
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ env.COOLIFY_IP }} << 'EOF'
          echo "=== Docker バージョン ==="
          docker --version
          echo ""
          echo "=== 実行中のコンテナ ==="
          docker ps
          echo ""
          echo "=== クラウドイニット完了ログ ==="
          cat /var/log/cloud-init-complete.log 2>/dev/null || echo "ログなし"
          EOF

      # =============================================
      # 14. Terraform Destroy（オプション）
      # =============================================
      - name: Terraform Destroy
        if: ${{ github.event.inputs.action == 'destroy' }}
        run: |
          cd ${{ github.workspace }}
          terraform destroy -target=proxmox_virtual_environment_vm.coolify -auto-approve
          echo "✓ VM を削除しました"

      # =============================================
      # 15. 接続情報を出力
      # =============================================
      - name: セットアップ完了情報
        if: ${{ github.event.inputs.action == 'setup' }}
        run: |
          echo "========================================="
          echo "✓ Coolify セットアップ完了"
          echo "========================================="
          echo ""
          echo "Coolify ダッシュボード:"
          echo "  URL: http://${{ env.COOLIFY_IP }}:8000"
          echo ""
          echo "SSH アクセス:"
          echo "  ssh ubuntu@${{ env.COOLIFY_IP }}"
          echo "  パスワード: Coolify2024!"
          echo ""
          echo "Docker コンテナ確認:"
          echo "  docker ps"
          echo ""
          echo "========================================="
