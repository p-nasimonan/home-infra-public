name: Coolify セットアップ自動化

on:
  workflow_dispatch:
    inputs:
      action:
        description: "実行するアクション"
        required: true
        default: "setup"
        type: choice
        options:
          - setup
          - destroy
          - verify

jobs:
  coolify-setup:
    runs-on: self-hosted  # infra-runner で実行
    steps:
      # =============================================
      # 1. リポジトリをチェックアウト
      # =============================================
      - name: チェックアウト
        uses: actions/checkout@v4

      # =============================================
      # 1.5. Terraform 環境変数を設定
      # =============================================
      - name: Terraform 環境変数を設定
        if: ${{ github.event.inputs.action == 'setup' || github.event.inputs.action == 'destroy' }}
        run: |
          echo "TF_VAR_cloudflare_api_token=${{ secrets.CLOUDFLARE_API_TOKEN }}" >> $GITHUB_ENV
          echo "TF_VAR_proxmox_token_id=${{ secrets.PROXMOX_TOKEN_ID }}" >> $GITHUB_ENV
          echo "TF_VAR_proxmox_token_secret=${{ secrets.PROXMOX_TOKEN_SECRET }}" >> $GITHUB_ENV
          echo "TF_API_TOKEN=${{ secrets.TF_API_TOKEN }}" >> $GITHUB_ENV

      # =============================================
      # 2. Terraform 初期化と情報取得
      # =============================================
      - name: Terraform 初期化
        if: ${{ github.event.inputs.action == 'setup' || github.event.inputs.action == 'destroy' }}
        run: |
          cd ${{ github.workspace }}
          terraform init

      - name: monaka node IP を設定
        if: ${{ github.event.inputs.action == 'setup' }}
        run: |
          # monaka node の IP アドレス
          echo "MONAKA_HOST=192.168.0.8" >> $GITHUB_ENV
          echo "monaka IP: 192.168.0.8"

      # =============================================
      # 3. SSH キーを設定（Proxmox アクセス用）
      # =============================================
      - name: SSH キーを設定
        if: ${{ github.event.inputs.action == 'setup' }}
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PROXMOX_SSH_KEY }}" > ~/.ssh/proxmox_key
          chmod 600 ~/.ssh/proxmox_key
          ssh-keyscan -t rsa ${{ env.MONAKA_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      # =============================================
      # 4. クラウドイメージをダウンロード（初回のみ）
      # =============================================
      - name: クラウドイメージをダウンロード
        if: ${{ github.event.inputs.action == 'setup' }}
        run: |
          ssh -i ~/.ssh/proxmox_key root@${{ env.MONAKA_HOST }} << 'EOF'
          set -e
          mkdir -p /var/lib/vz/template/iso
          if [ ! -f /var/lib/vz/template/iso/jammy-server-cloudimg-amd64.img ]; then
            echo "クラウドイメージをダウンロード中..."
            cd /var/lib/vz/template/iso
            wget -q https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img
            echo "ダウンロード完了"
          else
            echo "クラウドイメージは既に存在します"
          fi
          EOF

      # =============================================
      # 4.5. cloud-init 設定ファイルを Proxmox に配置
      # =============================================
      - name: cloud-init ファイルを Proxmox に配置
        if: ${{ github.event.inputs.action == 'setup' }}
        run: |
          ssh -i ~/.ssh/proxmox_key root@${{ env.MONAKA_HOST }} << 'EOF'
          set -e
          mkdir -p /var/lib/vz/snippets
          
          # cloud-init ファイルを作成
          cat > /var/lib/vz/snippets/coolify-init.yaml << 'CLOUDINIT'
          #cloud-config
          package_update: true
          packages:
            - openssh-server
            - qemu-guest-agent
          ssh_pwauth: true
          disable_root: false
          CLOUDINIT
          
          chmod 644 /var/lib/vz/snippets/coolify-init.yaml
          echo "✓ cloud-init ファイルを配置しました"
          ls -lh /var/lib/vz/snippets/coolify-init.yaml
          EOF

      # =============================================
      # 5. Terraform Plan（確認）
      # =============================================
      - name: Terraform Plan
        if: ${{ github.event.inputs.action == 'setup' }}
        run: |
          cd ${{ github.workspace }}
          terraform plan -target=proxmox_virtual_environment_vm.coolify -out=tfplan

      # =============================================
      # 6. Terraform Apply（VM 作成）
      # =============================================
      - name: Terraform Apply
        if: ${{ github.event.inputs.action == 'setup' }}
        run: |
          cd ${{ github.workspace }}
          terraform apply -target=proxmox_virtual_environment_vm.coolify -auto-approve

      # =============================================
      # 7. VM の IP を取得（固定IP: 10.0.0.10）
      # =============================================
      - name: VM の IP を取得
        if: ${{ github.event.inputs.action == 'setup' }}
        run: |
          cd ${{ github.workspace }}
          # 固定IP（内部ネットワーク: 10.0.0.0/24）
          COOLIFY_IP=$(terraform output -raw coolify_vm_ip 2>/dev/null || echo "10.0.0.10")
          echo "COOLIFY_IP=$COOLIFY_IP" >> $GITHUB_ENV
          echo "VM の IP: $COOLIFY_IP（内部ネットワーク: 10.0.0.0/24）"
          
          # Terraform state から VM 情報を確認
          echo "=== VM 情報 ==="
          terraform state show proxmox_virtual_environment_vm.coolify 2>/dev/null | grep -E "vm_id|name|node_name" || echo "VM 情報取得失敗"

      # =============================================
      # 7.5. Proxmox から VM 状態を確認
      # =============================================
      - name: Proxmox 上の VM 状態を確認
        if: ${{ github.event.inputs.action == 'setup' }}
        run: |
          ssh -i ~/.ssh/proxmox_key root@${{ env.MONAKA_HOST }} << 'EOF'
          echo "=== Proxmox 上の VM 一覧 ==="
          qm list | grep -i coolify || echo "coolify VM が見つかりません"
          
          # VM の詳細情報（ID 106 で確認）
          echo ""
          echo "=== VM 106 の状態 ==="
          qm status 106 2>/dev/null || echo "VM 106 が見つかりません"
          
          # VM のネットワーク設定
          echo ""
          echo "=== VM 106 のネットワーク ==="
          qm config 106 | grep net || echo "ネットワーク設定が見つかりません"
          EOF

      # =============================================
      # 8. VM の起動を待機
      # =============================================
      - name: VM の起動を待機（30秒）
        if: ${{ github.event.inputs.action == 'setup' }}
        run: sleep 30

      # =============================================
      # 9. Ansible Inventory の確認
      # =============================================
      - name: Ansible Inventory の確認
        if: ${{ github.event.inputs.action == 'setup' }}
        run: |
          cd ${{ github.workspace }}/ansible
          cat inventory.ini
          echo ""
          echo "Inventory の内容を確認："
          cat inventory.ini

      # =============================================
      # 11. Ansible Ping テスト
      # =============================================
      - name: Ansible Ping テスト
        if: ${{ github.event.inputs.action == 'setup' }}
        run: |
          cd ${{ github.workspace }}/ansible
          ansible all -i inventory.ini -m ping -v

      # =============================================
      # 12. Ansible Playbook 実行
      # =============================================
      - name: Ansible で Coolify をインストール
        if: ${{ github.event.inputs.action == 'setup' }}
        run: |
          cd ${{ github.workspace }}/ansible
          ansible-playbook -i inventory.ini playbook-coolify.yml -v

      # =============================================
      # 13. インストール確認
      # =============================================
      - name: Docker / Coolify ステータス確認
        if: ${{ github.event.inputs.action == 'setup' }}
        env:
          COOLIFY_IP: "10.0.0.10"
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ env.COOLIFY_IP }} << 'EOF'
          echo "=== Docker バージョン ==="
          docker --version
          echo ""
          echo "=== 実行中のコンテナ ==="
          docker ps
          echo ""
          echo "=== クラウドイニット完了ログ ==="
          cat /var/log/cloud-init-complete.log 2>/dev/null || echo "ログなし"
          EOF

      # =============================================
      # 14. Terraform Destroy（オプション）
      # =============================================
      - name: Terraform Destroy
        if: ${{ github.event.inputs.action == 'destroy' }}
        run: |
          cd ${{ github.workspace }}
          terraform destroy -target=proxmox_virtual_environment_vm.coolify -auto-approve
          echo "✓ VM を削除しました"

      # =============================================
      # 15. 接続情報を出力
      # =============================================
      - name: セットアップ完了情報
        if: ${{ github.event.inputs.action == 'setup' }}
        env:
          COOLIFY_IP: "10.0.0.10"
        run: |
          echo "========================================="
          echo "✓ Coolify セットアップ完了"
          echo "========================================="
          echo ""
          echo "Coolify ダッシュボード:"
          echo "  URL: http://${{ env.COOLIFY_IP }}:8000"
          echo ""
          echo "SSH アクセス:"
          echo "  ssh ubuntu@${{ env.COOLIFY_IP }}"
          echo "  パスワード: Coolify2024!"
          echo ""
          echo "Docker コンテナ確認:"
          echo "  docker ps"
          echo ""
          echo "========================================="
