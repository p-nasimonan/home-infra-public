name: Ansible ArgoCD Install

# ==========================================
# トリガー
# ==========================================
on:
  # Ansible ファイル変更時に実行
  push:
    branches:
      - main
    paths:
      - 'ansible/playbook-argocd-install.yml'
      - 'ansible/roles/argocd/**'
      - 'ansible/inventory.yml'
      - '.github/workflows/ansible-argocd-install.yml'

  # 手動トリガー
  workflow_dispatch:

jobs:
  # =========================================
  # Deploy: ArgoCD インストール
  # =========================================
  deploy:
    name: Deploy - ArgoCD Install
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 60

    env:
      ANSIBLE_WORK_DIR: ./ansible

    defaults:
      run:
        working-directory: ${{ env.ANSIBLE_WORK_DIR }}

    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4

      - name: Python 3.11 をセットアップ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: '**/requirements.txt'

      - name: Python 依存パッケージをインストール
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ansible ロールをインストール
        run: |
          mkdir -p roles
          ansible-galaxy install -r requirements.yml -p roles -f

      - name: SSH キーをセットアップ
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "${{ secrets.ANSIBLE_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 192.168.0.20 >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: ホストへの接続テスト
        run: |
          ansible all -i inventory.yml -m ping

      - name: Kubernetes 接続テスト
        run: |
          ansible k3s_servers -i inventory.yml -m shell -a "kubectl cluster-info" || true
          ansible k3s_servers -i inventory.yml -m shell -a "kubectl get nodes" || true

      - name: Ansible 構文チェック
        run: |
          ansible-playbook -i inventory.yml playbook-argocd-install.yml --syntax-check

      - name: ArgoCD インストール（GitHub SSO付き）
        env:
          ARGOCD_GITHUB_CLIENT_ID: ${{ secrets.ARGOCD_GITHUB_CLIENT_ID }}
          ARGOCD_GITHUB_CLIENT_SECRET: ${{ secrets.ARGOCD_GITHUB_CLIENT_SECRET }}
          ARGOCD_GITHUB_USERNAME: ${{ github.actor }}
        run: |
          ansible-playbook -i inventory.yml playbook-argocd-install.yml \
            -e "github_client_id=${ARGOCD_GITHUB_CLIENT_ID}" \
            -e "github_client_secret=${ARGOCD_GITHUB_CLIENT_SECRET}" \
            -e "github_admin_username=${ARGOCD_GITHUB_USERNAME}" \
            -v

      - name: 実行完了
        if: always()
        run: |
          echo "## ArgoCD インストール完了"
          echo "- URL: https://argocd.youkan.uk"
          echo "- Username: admin"
          echo ""
          echo "【次のステップ】"
          echo "1. ArgoCD UI にログイン"
          echo "2. Git repository を登録"
          echo "3. applications/app-of-apps.yaml を kubectl apply"
