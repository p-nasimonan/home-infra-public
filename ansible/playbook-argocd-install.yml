---
# ==========================================
# ArgoCD のインストール
# ==========================================
# GitOps ベースの CD ツール
# Rancher サーバー（rancher-server）上に Helm でインストール
#
# 前提条件:
#   - Rancher が起動している状態
#   - /etc/hosts に rancher.youkan.uk が設定済み（内部通信用）
#   - 外部アクセスは Cloudflare Tunnel 経由
# ==========================================
- name: Install ArgoCD on Rancher Cluster
  hosts: rancher_servers
  vars:
    # ドメイン設定（プライベートアクセス用）
    argocd_domain: "argocd.youkan.uk"

    # ArgoCD バージョン
    argocd_version: "v2.11.0"

    # ArgoCD namespace
    argocd_namespace: "argocd"

    # ArgoCD admin password（GitHub Actions Secret から）
    argocd_admin_password: "{{ argocd_password }}"

  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

  tasks:
    # -----------------------------------------------
    # 前置き：既に Python・kubectl・helm が整備されているため省略
    # Namespace は Helm の create_namespace: yes で自動作成
    # -----------------------------------------------

    # -----------------------------------------------
    # 1. ArgoCD Helm リポジトリ追加
    # -----------------------------------------------
    - name: ArgoCD Helm リポジトリを追加
      kubernetes.core.helm_repository:
        name: argo
        repo_url: "https://argoproj.github.io/argo-helm"
        kubeconfig: /etc/rancher/k3s/k3s.yaml

    # -----------------------------------------------
    # 2. ArgoCD をインストール（Helm、Namespace 自動作成）
    # -----------------------------------------------
    - name: ArgoCD をインストール（Helm、Namespace 自動作成）
      kubernetes.core.helm:
        name: argocd
        chart_ref: argo/argo-cd
        release_namespace: "{{ argocd_namespace }}"
        create_namespace: yes
        chart_version: "{{ argocd_version }}"
        update_repo_cache: true
        kubeconfig: /etc/rancher/k3s/k3s.yaml
        wait: yes
        wait_timeout: 15m
        values:
          server:
            # SSL 終端を Traefik に任せるために必須
            extraArgs:
              - --insecure
            service:
              type: ClusterIP
            ingress:
              enabled: true
              ingressClassName: traefik
              hosts:
                - "{{ argocd_domain }}"
              tls:
                - secretName: argocd-tls
                  hosts:
                    - "{{ argocd_domain }}"
          # HA 構成ではない場合、Redis の永続化を切るとエラー回避
          redis:
            enabled: true
          controller:
            replicas: 1
          repoServer:
            replicas: 1
          configs:
            params:
              application.instanceLabelKey: argocd.argoproj.io/instance

    # -----------------------------------------------
    # 3. ArgoCD admin password を設定
    # -----------------------------------------------
    - name: ArgoCD secret を更新（admin password）
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: argocd-secret
            namespace: "{{ argocd_namespace }}"
          type: Opaque
          stringData:
            # Ansible の password_hash フィルターで bcrypt ハッシュ化
            # 外部ライブラリ不要（builtin フィルター）
            admin.password: "{{ argocd_admin_password | password_hash('bcrypt', rounds=12) }}"
        kubeconfig: /etc/rancher/k3s/k3s.yaml

    # -----------------------------------------------
    # 4. ArgoCD の起動確認
    # -----------------------------------------------
    - name: ArgoCD Server Deployment の起動を待機
      kubernetes.core.k8s_info:
        kind: Deployment
        name: argocd-server
        namespace: "{{ argocd_namespace }}"
        kubeconfig: /etc/rancher/k3s/k3s.yaml
      register: argocd_deployment
      until: 
        - argocd_deployment.resources | length > 0
        - argocd_deployment.resources[0].status.readyReplicas is defined
        - argocd_deployment.resources[0].status.readyReplicas > 0
      retries: 30
      delay: 10

    - name: ArgoCD リソース一覧を表示
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ argocd_namespace }}"
        kubeconfig: /etc/rancher/k3s/k3s.yaml
      register: argocd_pods
      changed_when: false

    - name: ArgoCD Pod 情報を表示
      debug:
        msg: |
          ArgoCD Pods:
          {{ argocd_pods.resources | map(attribute='metadata.name') | list }}

    # -----------------------------------------------
    # 5. ArgoCD CLI をインストール
    # -----------------------------------------------
    - name: ArgoCD CLI がインストール済みか確認
      shell: which argocd
      register: argocd_cli_check
      changed_when: false
      ignore_errors: yes

    - name: ArgoCD CLI をダウンロード・インストール
      shell: |
        ARGOCD_VERSION="{{ argocd_version }}"
        curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/download/${ARGOCD_VERSION}/argocd-linux-amd64
        sudo mv /tmp/argocd /usr/local/bin/argocd
        sudo chmod +x /usr/local/bin/argocd
      args:
        executable: /bin/bash
      when: argocd_cli_check.rc != 0

    - name: ArgoCD CLI バージョン確認
      shell: argocd version --short
      register: argocd_cli_version
      changed_when: false
      ignore_errors: yes

    - name: ArgoCD CLI バージョン情報
      debug:
        msg: "{{ argocd_cli_version.stdout | default('CLI インストール失敗') }}"
      ignore_errors: yes

# ==========================================
# 次のステップ: Git リポジトリ登録とアプリケーション管理
# ==========================================
# ArgoCD へ Git リポジトリを登録し、
# Application リソースを定義してデプロイを自動化


