---
# ==========================================
# ArgoCD のインストール
# ==========================================
# GitOps ベースの CD ツール
# Rancher サーバー（rancher-server）上に Helm でインストール
#
# 前提条件:
#   - Rancher が起動している状態
#   - /etc/hosts に rancher.youkan.uk が設定済み（内部通信用）
#   - 外部アクセスは Cloudflare Tunnel 経由
# ==========================================
- name: Install ArgoCD on Rancher Cluster
  hosts: rancher_servers
  vars:
    # ドメイン設定（プライベートアクセス用）
    argocd_domain: "argocd.youkan.uk"

    # ArgoCD バージョン
    argocd_version: "v2.11.0"

    # ArgoCD namespace
    argocd_namespace: "argocd"

    # ArgoCD admin password（GitHub Actions Secret から）
    argocd_admin_password: "{{ argocd_password }}"

  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

  tasks:
    # -----------------------------------------------
    # 前置き：既に Python・kubectl・helm が整備されているため省略
    # -----------------------------------------------

    # -----------------------------------------------
    # 1. ArgoCD Namespace 作成
    # -----------------------------------------------
    - name: ArgoCD namespace を作成
      shell: |
        kubectl create namespace {{ argocd_namespace }} --dry-run=client -o yaml | kubectl apply -f -
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      changed_when: false

    # -----------------------------------------------
    # 2. ArgoCD Helm リポジトリ追加
    # -----------------------------------------------
    - name: ArgoCD Helm リポジトリを追加
      shell: |
        helm repo add argo https://argoproj.github.io/argo-helm
        helm repo update
      args:
        executable: /bin/bash

    # -----------------------------------------------
    # 3. ArgoCD をインストール（Helm）
    # -----------------------------------------------
    - name: ArgoCD をインストール（Helm）
      shell: |
        helm upgrade --install argocd argo/argo-cd \
          --namespace {{ argocd_namespace }} \
          --version {{ argocd_version }} \
          --set server.service.type=ClusterIP \
          --set server.ingress.enabled=true \
          --set server.ingress.ingressClassName=traefik \
          --set "server.ingress.hosts={{{ argocd_domain }}}}" \
          --set server.ingress.tls[0].secretName=argocd-tls \
          --set "server.ingress.tls[0].hosts={{{ argocd_domain }}}}" \
          --set "server.extraArgs={--insecure}" \
          --set controller.replicas=1 \
          --set repoServer.replicas=1 \
          --set redis.enabled=true \
          --set configs.params."application\.instanceLabelKey"=argocd.argoproj.io/instance \
          --wait --timeout 15m
      args:
        executable: /bin/bash
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    # -----------------------------------------------
    # 4. ArgoCD admin password を設定
    # -----------------------------------------------
    - name: ArgoCD admin password をハッシュ化
      shell: |
        python3 << 'EOF'
        import bcrypt
        password = "{{ argocd_admin_password }}".encode('utf-8')
        hashed = bcrypt.hashpw(password, bcrypt.gensalt(rounds=12))
        print(hashed.decode('utf-8'))
        EOF
      register: argocd_password_hash
      changed_when: false

    - name: ArgoCD secret を更新（admin password）
      shell: |
        kubectl patch secret argocd-secret -n {{ argocd_namespace }} \
          -p '{"stringData":{"admin.password":"{{ argocd_password_hash.stdout }}"}}'
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      changed_when: false

    # -----------------------------------------------
    # 5. ArgoCD の起動確認
    # -----------------------------------------------
    - name: ArgoCD Server Pod の起動を待機
      shell: |
        kubectl get pods -n {{ argocd_namespace }} -l app.kubernetes.io/name=argocd-server \
          -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "NotReady"
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: argocd_ready
      until: argocd_ready.stdout == "Running"
      retries: 30
      delay: 10

    - name: ArgoCD ポッド一覧を表示
      shell: |
        kubectl get pods -n {{ argocd_namespace }}
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: argocd_pods
      changed_when: false

    - name: ArgoCD ポッド情報
      debug:
        msg: "{{ argocd_pods.stdout }}"

    - name: ArgoCD Service & Ingress を確認
      shell: |
        kubectl get svc,ing -n {{ argocd_namespace }}
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: argocd_resources
      changed_when: false

    - name: ArgoCD リソース情報
      debug:
        msg: "{{ argocd_resources.stdout }}"

    # -----------------------------------------------
    # 6. ArgoCD CLI をインストール
    # -----------------------------------------------
    - name: ArgoCD CLI がインストール済みか確認
      shell: which argocd
      register: argocd_cli_check
      changed_when: false
      ignore_errors: yes

    - name: ArgoCD CLI をダウンロード・インストール
      shell: |
        ARGOCD_VERSION="{{ argocd_version }}"
        curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/download/${ARGOCD_VERSION}/argocd-linux-amd64
        sudo mv /tmp/argocd /usr/local/bin/argocd
        sudo chmod +x /usr/local/bin/argocd
      args:
        executable: /bin/bash
      when: argocd_cli_check.rc != 0

    - name: ArgoCD CLI バージョン確認
      shell: argocd version --short
      register: argocd_cli_version
      changed_when: false
      ignore_errors: yes

    - name: ArgoCD CLI バージョン情報
      debug:
        msg: "{{ argocd_cli_version.stdout | default('CLI インストール失敗') }}"
      ignore_errors: yes

# ==========================================
# 次のステップ: Git リポジトリ登録とアプリケーション管理
# ==========================================
# ArgoCD へ Git リポジトリを登録し、
# Application リソースを定義してデプロイを自動化


