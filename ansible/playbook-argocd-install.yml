---
# ==========================================
# ArgoCD のインストール
# ==========================================
# GitOps ベースの CD ツール
# K3s-server-1 上に Helm でインストール
#
# 実行方法:
#   ansible-playbook -i inventory.yml playbook-argocd-install.yml

- name: Install ArgoCD on K3s Cluster
  hosts: k3s_servers
  tags:
    - argocd
  become: yes
  vars:
    argocd_domain: "argocd.youkan.uk"
    argocd_namespace: "argocd"
    argocd_chart_version: "9.1.3"
    ansible_python_interpreter: /usr/bin/python3
    github_client_id: "{{ lookup('env', 'ARGOCD_GITHUB_CLIENT_ID') }}"
    github_client_secret: "{{ lookup('env', 'ARGOCD_GITHUB_CLIENT_SECRET') }}"
    github_admin_username: "{{ lookup('env', 'ARGOCD_GITHUB_USERNAME') | default('') }}"

  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

  tasks:
    # k3s-server-1 のみで実行
    - name: k3s-server-1 でのみ ArgoCD をインストール
      block:
        # Python 仮想環境セットアップ
        - name: Python 仮想環境を作成
          shell: |
            python3 -m venv /opt/ansible-venv
          args:
            executable: /bin/bash
          changed_when: false

        - name: 仮想環境に必要なパッケージをインストール
          shell: |
            /opt/ansible-venv/bin/pip install --upgrade pip setuptools wheel
            /opt/ansible-venv/bin/pip install kubernetes>=21.0.0 pyyaml>=5.4.1
          args:
            executable: /bin/bash

        - name: Python インタープリタを仮想環境に設定
          set_fact:
            ansible_python_interpreter: /opt/ansible-venv/bin/python3

        # Helm インストール
        - name: Helm をインストール
          shell: |
            if ! command -v helm >/dev/null 2>&1; then
              curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
            fi
          args:
            executable: /bin/bash
          changed_when: false

        # ArgoCD Helm リポジトリ追加
        - name: ArgoCD Helm リポジトリを追加
          kubernetes.core.helm_repository:
            name: argo
            repo_url: "https://argoproj.github.io/argo-helm"
            kubeconfig: /etc/rancher/k3s/k3s.yaml

        # ArgoCD インストール
        - name: ArgoCD をインストール
          kubernetes.core.helm:
            name: argocd
            chart_ref: argo/argo-cd
            release_namespace: "{{ argocd_namespace }}"
            create_namespace: yes
            chart_version: "{{ argocd_chart_version }}"
            update_repo_cache: true
            kubeconfig: /etc/rancher/k3s/k3s.yaml
            wait: yes
            wait_timeout: 15m
            values:
              global:
                domain: "{{ argocd_domain }}"
              server:
                extraArgs:
                  - --insecure
                service:
                  port: 80
                  targetPort: 8080
                  type: ClusterIP
                ingress:
                  enabled: true
                  ingressClassName: traefik
                  annotations:
                    traefik.ingress.kubernetes.io/service.serversscheme: http
                  hosts:
                    - host: "{{ argocd_domain }}"
                      paths:
                        - path: /
                          pathType: Prefix
              controller:
                replicas: 1
              repoServer:
                replicas: 1
              configs:
                cm:
                  # GitHub SSO 設定
                  dex.config: |
                    connectors:
                      - type: github
                        id: github
                        name: GitHub
                        config:
                          clientID: {{ github_client_id }}
                          clientSecret: {{ github_client_secret }}
                          orgs:
                            - name: p-nasimonan
                  # ローカルログインを無効化
                  accounts.password.autoGenerate: "false"
                rbac:
                  # すべてのユーザーに admin 権限を付与（GitHub SSO経由のみ）
                  policy.default: role:admin
                  policy.csv: |
                    p, admin, *, *, allow
                    g, {{ github_admin_username }}, admin

        # ArgoCD 起動確認
        - name: ArgoCD が起動するまで待機
          shell: |
            kubectl get deployment -n {{ argocd_namespace }} argocd-server -o jsonpath='{.status.readyReplicas}' 2>/dev/null || echo 0
          environment:
            KUBECONFIG: /etc/rancher/k3s/k3s.yaml
          register: argocd_replicas
          until: argocd_replicas.stdout | int > 0
          retries: 30
          delay: 10

        # ArgoCD CLI インストール
        - name: ArgoCD CLI をインストール
          shell: |
            if ! command -v argocd >/dev/null 2>&1; then
              curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/download/v3.2.0/argocd-linux-amd64
              chmod +x /usr/local/bin/argocd
            fi
          args:
            executable: /bin/bash
          changed_when: false

        # セットアップ完了
        - name: ArgoCD セットアップ完了
          debug:
            msg: "✓ ArgoCD は https://{{ argocd_domain }} でアクセス可能です"

      when: inventory_hostname == "k3s-server-1"



