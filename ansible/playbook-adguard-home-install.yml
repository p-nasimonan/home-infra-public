---
# ==========================================
# AdGuard Home のインストール
# ==========================================
# 内向け DNS サーバー
# LXC コンテナ (192.168.0.30) にインストール
#
# 実行方法:
#   ansible-playbook -i inventory.yml playbook-adguard-home-install.yml

- name: Install AdGuard Home on LXC Container
  hosts: adguard_home
  become: yes
  vars:
    adguard_home_version: "latest"
    adguard_home_port: 3000
    adguard_home_dns_port: 53
    adguard_home_admin_password: "{{ lookup('env', 'ADGUARD_ADMIN_PASSWORD') | default('admin123') }}"
    
    # 内向け DNS エントリ（コード管理）
    dns_entries:
      - domain: "*.k.youkan.uk"
        ip: "192.168.0.20"
        description: "K3s Services Wildcard (Rancher, ArgoCD, etc.)"
      - domain: "adguard.youkan.uk"
        ip: "192.168.0.30"
        description: "AdGuard Home"

  tasks:
    # =========================================
    # システムパッケージ更新
    # =========================================
    - name: システムパッケージを更新
      apt:
        update_cache: yes
        upgrade: dist
        cache_valid_time: 3600

    - name: 必要なパッケージをインストール
      apt:
        name:
          - curl
          - wget
          - ca-certificates
          - systemd
          - python3-requests
        state: present

    # =========================================
    # AdGuard Home インストール（公式スクリプト使用）
    # =========================================
    - name: AdGuard Home を公式スクリプトでインストール
      shell: |
        curl -s -S -L https://raw.githubusercontent.com/AdguardTeam/AdGuardHome/master/scripts/install.sh | sh -s -- -v
      args:
        executable: /bin/bash
      changed_when: false
      ignore_errors: yes

    # =========================================
    # AdGuard Home 設定
    # =========================================
    - name: AdGuard Home 設定ディレクトリを作成
      file:
        path: /opt/adguardhome
        state: directory
        mode: '0755'

    - name: AdGuard Home コンフィグを配置
      copy:
        content: |
          ---
          http:
            address: 0.0.0.0:{{ adguard_home_port }}
            
          dns:
            port: {{ adguard_home_dns_port }}
            statistics_interval: 1
            querylog_enabled: true
            upstream_dns:
              - 8.8.8.8:53
              - 1.1.1.1:53
            
          filters:
            - enabled: true
              url: https://adguardteam.github.io/AdGuardSDNSFilter/Filters/filter.txt
              name: AdGuard DNS filter
            - enabled: true
              url: https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts
              name: Steven Black's hosts
          
          user_rules: []
          
          blocked_services: []
          
          clients: []
          
          log_file: ""
          verbose: false
          
          schema_version: 14
        dest: /opt/adguardhome/AdGuardHome.yaml
        mode: '0644'

    - name: AdGuard Home が起動するまで待機
      wait_for:
        host: 127.0.0.1
        port: "{{ adguard_home_port }}"
        delay: 5
        timeout: 60

    # =========================================
    # セットアップ完了
    # =========================================
    - name: AdGuard Home セットアップ完了
      debug:
        msg: |
          ✓ AdGuard Home セットアップ完了
          - Web UI: http://192.168.0.30:{{ adguard_home_port }}
          - DNS Server: 192.168.0.30:{{ adguard_home_dns_port }}
          
          【初期設定】
          1. Web UI にアクセス: http://192.168.0.30:{{ adguard_home_port }}
          2. 管理者パスワードを設定（初期セットアップウィザード）
          3. DNS レコード設定: Filters → Custom Filtering Rules で以下を追加
             {% for entry in dns_entries %}
             {{ entry.ip }}  {{ entry.domain }}
             {% endfor %}
