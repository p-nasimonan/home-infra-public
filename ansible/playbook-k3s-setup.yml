---
# ==========================================
# xanmanning.k3s を使用した K3s クラスタセットアップ
# ==========================================
# 用途:
#   - K3s クラスタを Proxmox VM 上に自動デプロイ
#   - embedded etcd による HA構成（3 ノード）
#   - K3s-server-1 に Rancher を Helm でインストール
#
# 実行方法:
#   ansible-playbook -i inventory.yml playbook-k3s-setup.yml

- name: K3s クラスタセットアップ
  hosts: k3s_servers
  tags:
    - setup
    - k3s
  vars:
    # ==========================================
    # kube-vip 設定
    # ==========================================
    kube_vip_address: "192.168.0.200"
    kube_vip_interface: "eth0"
    kube_vip_version: "v0.8.0"
    kube_vip_domain: "kube.youkan.uk"

    # ==========================================
    # K3s 基本設定
    # ==========================================
    k3s_release_version: false
    k3s_etcd_datastore: true
    k3s_server:
      flannel-backend: vxlan
      audit-log-maxage: 30
      audit-log-maxbackup: 10
      audit-log-maxsize: 100
      # kube-vip VIP を TLS SAN に追加
      tls-san:
        - "{{ kube_vip_address }}"
        - "{{ kube_vip_domain }}"
      # kube-vip をロードバランサーとして使用するため、デフォルトの servicelb を無効化
      disable: servicelb
    k3s_agent:
      node-label:
        - "node-role=worker"
    k3s_skip_validation: false
    ansible_python_interpreter: /usr/bin/python3


  
  pre_tasks:
    # Python ブートストラップ
    - name: Python3 をブートストラップ
      raw: |
        if command -v python3 >/dev/null 2>&1; then
          exit 0
        fi
        sudo apt-get update -y
        sudo apt-get install -y python3 python3-apt python3-pip
      changed_when: false

    # パッケージ更新
    - name: パッケージをアップデート
      apt:
        update_cache: yes
        cache_valid_time: 3600
        upgrade: dist
        autoremove: yes
        autoclean: yes
      become: yes

    # 必要パッケージをインストール
    - name: 必要なパッケージをインストール
      apt:
        name:
          - curl
          - wget
          - git
          - vim
          - htop
          - net-tools
          - ntp
          - python3-venv
        state: present
      become: yes

    # タイムゾーン設定
    - name: タイムゾーンを Asia/Tokyo に設定
      timezone:
        name: Asia/Tokyo
      become: yes

    # IP フォワーディング
    - name: IP フォワーディングを有効化
      sysctl:
        name: net.ipv4.ip_forward
        value: "1"
        sysctl_set: yes
        state: present
      become: yes

    # br_netfilter モジュール
    - name: br_netfilter モジュールをロード
      modprobe:
        name: br_netfilter
        state: present
      become: yes
      ignore_errors: yes

    # ブリッジネットワーク設定
    - name: ブリッジネットワーク iptables サポートを有効化
      sysctl:
        name: net.bridge.bridge-nf-call-iptables
        value: "1"
        sysctl_set: yes
        state: present
      become: yes
      ignore_errors: yes

    # /etc/hosts に K3s ドメイン追加
    - name: /etc/hosts に K3s 関連ドメインを追加
      lineinfile:
        path: /etc/hosts
        line: "{{ item }}"
        state: present
      become: yes
      loop:
        - "192.168.0.20 rancher.youkan.uk argocd.youkan.uk k3s-server-1"
        - "192.168.0.21 k3s-server-2"
        - "192.168.0.22 k3s-server-3"
        - "{{ kube_vip_address }} {{ kube_vip_domain }}"

    # ===================================================================
    # K3sインストール前にkube-vipマニフェストを配置
    # K3s が /var/lib/rancher/k3s/server/manifests/ を監視して自動適用
    # 外部ファイル (manifests/kube-vip.yaml) からテンプレート処理して展開
    # ===================================================================
    - name: kube-vip マニフェスト用ディレクトリを作成
      file:
        path: /var/lib/rancher/k3s/server/manifests
        state: directory
        owner: root
        group: root
        mode: '0755'
      become: yes

    - name: kube-vip マニフェストを配置
      template:
        src: manifests/kube-vip.yaml
        dest: /var/lib/rancher/k3s/server/manifests/kube-vip.yaml
        owner: root
        group: root
        mode: '0600'
      become: yes

  roles:
    - role: xanmanning.k3s
      become: yes

  post_tasks:

    # K3s 起動確認
    - name: K3s が起動完了するまで待機
      shell: |
        k3s kubectl get nodes
      register: k3s_nodes_ready
      until: k3s_nodes_ready.rc == 0 and k3s_nodes_ready.stdout_lines | length > 0
      retries: 30
      delay: 10
      when: inventory_hostname == "k3s-server-1"

    # kubeconfig 取得
    - name: kubeconfig を取得
      fetch:
        src: /etc/rancher/k3s/k3s.yaml
        dest: ./kubeconfig.yaml
        flat: yes
      become: yes
      when: inventory_hostname == "k3s-server-1"

    # ===================================================================
    # kube-vip Cloud Controller のインストール
    # Service type LoadBalancer を kube-vip で制御するために必要
    # ===================================================================
    - name: kube-vip Cloud Controller をインストール
      shell: |
        kubectl apply -f https://raw.githubusercontent.com/kube-vip/kube-vip-cloud-provider/main/manifest/kube-vip-cloud-controller.yaml
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      become: yes
      when: inventory_hostname == "k3s-server-1"

    - name: kube-vip IP レンジを ConfigMap で設定
      shell: |
        kubectl get configmap kubevip -n kube-system >/dev/null 2>&1 && \
        kubectl patch configmap kubevip -n kube-system -p '{"data":{"range-global": "192.168.0.210-192.168.0.219"}}' || \
        kubectl create configmap kubevip -n kube-system --from-literal range-global=192.168.0.210-192.168.0.219
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      become: yes
      when: inventory_hostname == "k3s-server-1"
      register: kubevip_configmap
      changed_when: "'created' in kubevip_configmap.stdout or 'patched' in kubevip_configmap.stdout"

# ==========================================
# Rancher のインストール (Helm)
# ==========================================
- name: Rancher をデプロイ
  hosts: k3s_servers
  tags:
    - rancher
  become: yes
  vars:
    rancher_domain: "rancher.youkan.uk"
    rancher_version: "v2.13.1"
    cert_manager_version: "v1.15.3"
    rancher_bootstrap_password: "{{ lookup('env', 'RANCHER_PASSWORD') }}"
    ansible_python_interpreter: /usr/bin/python3

  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

  tasks:
    # k3s-server-1 のみで実行
    - name: K3s-server-1 でのみ Rancher をインストール
      block:
        # Python 仮想環境セットアップ
        - name: Python 仮想環境を作成
          shell: |
            python3 -m venv /opt/ansible-venv
          args:
            executable: /bin/bash
          changed_when: false

        - name: 仮想環境に必要なパッケージをインストール
          shell: |
            /opt/ansible-venv/bin/pip install --upgrade pip setuptools wheel
            /opt/ansible-venv/bin/pip install kubernetes>=21.0.0 pyyaml>=5.4.1
          args:
            executable: /bin/bash

        - name: Python インタープリタを仮想環境に設定
          set_fact:
            ansible_python_interpreter: /opt/ansible-venv/bin/python3

        # Helm インストール
        - name: Helm をインストール
          shell: |
            if ! command -v helm >/dev/null 2>&1; then
              curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
            fi
          args:
            executable: /bin/bash
          changed_when: false

        # Cert-Manager インストール
        - name: Jetstack Helm リポジトリを追加
          kubernetes.core.helm_repository:
            name: jetstack
            repo_url: "https://charts.jetstack.io"
            kubeconfig: /etc/rancher/k3s/k3s.yaml

        - name: Helm リポジトリを更新
          shell: helm repo update
          args:
            executable: /bin/bash
          changed_when: false

        - name: cert-manager をインストール
          kubernetes.core.helm:
            name: cert-manager
            chart_ref: jetstack/cert-manager
            release_namespace: cert-manager
            create_namespace: yes
            chart_version: "{{ cert_manager_version }}"
            values:
              installCRDs: true
            kubeconfig: /etc/rancher/k3s/k3s.yaml
            wait: yes
            wait_timeout: 10m

        # Cert-manager 起動確認
        - name: Cert-manager が起動するまで待機
          shell: |
            kubectl get deployment -n cert-manager cert-manager -o jsonpath='{.status.readyReplicas}' 2>/dev/null || echo 0
          environment:
            KUBECONFIG: /etc/rancher/k3s/k3s.yaml
          register: cert_manager_replicas
          until: cert_manager_replicas.stdout | int > 0
          retries: 30
          delay: 10

        # Rancher インストール
        - name: Rancher Helm リポジトリを追加
          kubernetes.core.helm_repository:
            name: rancher-latest
            repo_url: "https://releases.rancher.com/server-charts/latest"
            kubeconfig: /etc/rancher/k3s/k3s.yaml

        - name: Rancher をインストール
          kubernetes.core.helm:
            name: rancher
            chart_ref: rancher-latest/rancher
            release_namespace: cattle-system
            create_namespace: yes
            chart_version: "{{ rancher_version }}"
            values:
              hostname: "{{ rancher_domain }}"
              replicas: 1
              bootstrapPassword: "{{ rancher_bootstrap_password }}"
              ingress:
                enabled: true
                ingressClassName: traefik
                tls:
                  source: letsEncrypt
                  certManagerIssuer: letsencrypt-prod
            kubeconfig: /etc/rancher/k3s/k3s.yaml
            wait: yes
            wait_timeout: 15m

        # Rancher 起動確認
        - name: Rancher が起動するまで待機
          shell: |
            kubectl get deployment -n cattle-system rancher -o jsonpath='{.status.readyReplicas}' 2>/dev/null || echo 0
          environment:
            KUBECONFIG: /etc/rancher/k3s/k3s.yaml
          register: rancher_replicas
          until: rancher_replicas.stdout | int > 0
          retries: 30
          delay: 10

        - name: Rancher セットアップ完了
          debug:
            msg: "✓ Rancher は https://{{ rancher_domain }} でアクセス可能です"

      when: inventory_hostname == "k3s-server-1"

# ==========================================
# K3s マスターからトークンを取得
# ==========================================
# ワーカーがクラスタに参加するために必要なトークンを事前に取得
- name: K3s Control Plane からトークンを取得
  hosts: k3s_servers[0]  # k3s-server-1 のみから取得
  gather_facts: no
  tags:
    - setup
    - k3s
    - workers
  vars:
    ansible_python_interpreter: /usr/bin/python3

  tasks:
    - name: node-token ファイルを読み込み
      slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: k3s_node_token_raw
      become: yes
      ignore_errors: yes

    - name: トークンをデコード
      set_fact:
        k3s_node_token: "{{ k3s_node_token_raw.content | b64decode | trim }}"
      when: k3s_node_token_raw is not skipped

    - name: トークンをすべてのワーカーに共有
      set_fact:
        k3s_token: "{{ k3s_node_token }}"
      delegate_to: "{{ item }}"
      delegate_facts: true
      loop: "{{ groups['k3s_workers'] }}"
      when: k3s_node_token is defined

    - name: "トークン取得完了"
      debug:
        msg: "✓ K3s ワーカー参加用トークンを取得しました"

# ==========================================
# K3s ワーカーノードのセットアップ
# ==========================================
# Control Plane機能なしでワーカーノード のみをセットアップ

# ==========================================
# K3s ワーカーノードセットアップ 
# ==========================================
- name: K3s ワーカーノードセットアップ
  hosts: k3s_workers
  tags: [setup, k3s, workers]
  become: yes
  vars:
    # ----------------------------------------
    # 設定：ワーカーなのでコントロール機能はOFF
    # ----------------------------------------
    k3s_control_node: false
    k3s_build_cluster: false
    
    k3s_agent:
      node-label:
        - "node-role=worker"
        - "workload=minecraft"

  pre_tasks:
    # ----------------------------------------
    # 0. Ansible の変数を確定させる
    # ----------------------------------------
    - name: K3s 接続先と controller list を確定させる
      set_fact:
        kube_vip_address: "192.168.0.200"
        kube_vip_domain: "kube.youkan.uk"
        k3s_url: "https://192.168.0.200:6443"
        k3s_controller_list: "{{ groups['k3s_servers'] }}"
      run_once: true

    # ----------------------------------------
    # 1. マスターからトークンを強制的に吸い出す
    # ----------------------------------------
    - name: マスターノード (server-1) からトークンを読み取る
      slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: token_file
      delegate_to: "{{ groups['k3s_servers'][0] }}"

    - name: 読み取ったトークンを変数にセット
      set_fact:
        k3s_token: "{{ token_file.content | b64decode | trim }}"

    # ----------------------------------------
    # 2. Python3 をブートストラップ
    # ----------------------------------------
    - name: Python3 をブートストラップ
      raw: |
        if command -v python3 >/dev/null 2>&1; then
          exit 0
        fi
        sudo apt-get update -y
        sudo apt-get install -y python3 python3-apt python3-pip
      changed_when: false

    # ----------------------------------------
    # 3. パッケージ更新
    # ----------------------------------------
    - name: パッケージをアップデート
      apt:
        update_cache: yes
        cache_valid_time: 3600
        upgrade: dist
        autoremove: yes
        autoclean: yes
      become: yes

    # 必要パッケージをインストール
    - name: 必要なパッケージをインストール
      apt:
        name:
          - curl
          - wget
          - git
          - vim
          - htop
          - net-tools
          - ntp
          - python3-venv
        state: present
      become: yes

    # タイムゾーン設定
    - name: タイムゾーンを Asia/Tokyo に設定
      timezone:
        name: Asia/Tokyo
      become: yes

    # IP フォワーディング
    - name: IP フォワーディングを有効化
      sysctl:
        name: net.ipv4.ip_forward
        value: "1"
        sysctl_set: yes
        state: present
      become: yes

    # br_netfilter モジュール
    - name: br_netfilter モジュールをロード
      modprobe:
        name: br_netfilter
        state: present
      become: yes
      ignore_errors: yes

    # ブリッジネットワーク設定
    - name: ブリッジネットワーク iptables サポートを有効化
      sysctl:
        name: net.bridge.bridge-nf-call-iptables
        value: "1"
        sysctl_set: yes
        state: present
      become: yes
      ignore_errors: yes

  roles:
    - role: xanmanning.k3s
      become: yes

  post_tasks:
    # K3s トークン取得と接続確認
    - name: K3s Control Plane のトークンを取得
      slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: k3s_server_node_token
      become: yes
      delegate_to: "k3s-server-1"
      delegate_facts: false

    - name: K3s クラスタへのワーカー接続を確認
      shell: |
        k3s kubectl get nodes
      register: k3s_nodes
      changed_when: false
      delegate_to: "k3s-server-1"
      delegate_facts: false

    - name: ワーカーノード参加情報を表示
      debug:
        msg: |
          ✓ ワーカーノード（{{ inventory_hostname }}）がクラスタに参加しました
          {{ k3s_nodes.stdout_lines[-3:] }}
      when: inventory_hostname == "k3s-worker-1"

    - name: kube-vip が設定されたか確認
      shell: |
        kubectl get daemonset -n kube-system kube-vip
      register: kube_vip_status
      changed_when: false
      ignore_errors: true
      when: inventory_hostname == "k3s-server-1"

    - name: Rancher へのアクセス確認
      debug:
        msg: |
          ✓ Rancher から以下のノードが操作可能です：
            - Control Plane: k3s-server-1, k3s-server-2, k3s-server-3
            - Worker: k3s-worker-1, k3s-worker-2
          
          API Access: https://192.168.0.200:6443 (kube-vip)
          Web UI: https://rancher.youkan.uk
      when: inventory_hostname == "k3s-worker-1"

# ==========================================
# ノード数確認（全ノード参加を検証）
# ==========================================
- name: K3s クラスタ ノード確認
  hosts: k3s_servers[0]
  gather_facts: no
  tags:
    - setup
    - k3s

  tasks:
    - name: K3s ノード一覧を取得
      shell: |
        /usr/local/bin/kubectl get nodes -o jsonpath='{.items[*].metadata.name}'
      register: k3s_nodes_list
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      become: yes

    - name: ノード数をカウント
      set_fact:
        k3s_nodes_count: "{{ k3s_nodes_list.stdout.split() | length }}"
        k3s_nodes_names: "{{ k3s_nodes_list.stdout.split() }}"

    - name: 期待されるノード数
      set_fact:
        expected_nodes_count: 5  # 3つのControl Plane + 2つのWorker
        expected_nodes:
          - k3s-server-1
          - k3s-server-2
          - k3s-server-3
          - k3s-worker-1
          - k3s-worker-2

    - name: ノード数の検証
      assert:
        that:
          - k3s_nodes_count | int == expected_nodes_count | int
        fail_msg: |
          ❌ K3s クラスタに全ノードが参加していません
          期待: {{ expected_nodes_count }}個のノード
          実際: {{ k3s_nodes_count }}個のノード
          参加しているノード: {{ k3s_nodes_names | join(', ') }}
          欠落ノード: {{ expected_nodes | difference(k3s_nodes_names) | join(', ') if expected_nodes | difference(k3s_nodes_names) else 'なし' }}
        success_msg: |
          ✅ K3s クラスタ検証成功！
          すべてのノードが正常に参加しています
          参加ノード数: {{ k3s_nodes_count }}個
          ノード一覧: {{ k3s_nodes_names | join(', ') }}

    - name: ノードの詳細情報を表示
      shell: |
        /usr/local/bin/kubectl get nodes -o wide
      register: k3s_nodes_detail
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      become: yes

    - name: ノード詳細を出力
      debug:
        msg: |
          {{ k3s_nodes_detail.stdout }}
