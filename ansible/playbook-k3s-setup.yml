---
# ==========================================
# K3s クラスタ統合セットアップ (完全版)
# ==========================================
# サーバーもワーカーもまとめて1つのPlayで実行することで、
# Roleの自動連携機能(トークン共有など)を最大限に活用します。

- name: K3s クラスタ構築 (Server & Worker)
  hosts: k3s_servers,k3s_workers
  become: yes
  tags:
    - setup
    - k3s
  vars:
    # ----------------------------------------
    # 共通設定
    # ----------------------------------------
    kube_vip_address: "192.168.0.200"
    kube_vip_interface: "eth0"
    kube_vip_domain: "kube.youkan.uk"
    kube_vip_version: false
    k3s_release_version: false
    
    # ★重要: ワーカーはここ(VIP)に接続しに行きます
    k3s_registration_address: "192.168.0.200"

    # ----------------------------------------
    # Role制御設定
    # ----------------------------------------
    # サーバーグループに属しているならコントロールノードにする
    k3s_control_node: "{{ true if inventory_hostname in groups['k3s_servers'] else false }}"
    
    # HA構成のための設定
    k3s_etcd_datastore: "{{ true if inventory_hostname in groups['k3s_servers'] else false }}"
    
    # ----------------------------------------
    # Server用設定 (Workerでは無視されます)
    # ----------------------------------------
    k3s_server:
      flannel-backend: vxlan
      audit-log-maxage: 30
      audit-log-maxbackup: 10
      audit-log-maxsize: 100
      tls-san:
        - "{{ kube_vip_address }}"
        - "{{ kube_vip_domain }}"
      disable: servicelb

    # ----------------------------------------
    # Agent用設定 (全ノードに適用)
    # ----------------------------------------
    k3s_agent:
      node-label: >-
        {{
          ['node-role=worker', 'workload=minecraft']
          if inventory_hostname in groups['k3s_workers']
          else []
        }}

    k3s_skip_validation: false
    ansible_python_interpreter: /usr/bin/python3


  pre_tasks:
    # Python ブートストラップ
    - name: Python3 をブートストラップ
      raw: |
        if command -v python3 >/dev/null 2>&1; then
          exit 0
        fi
        sudo apt-get update -y
        sudo apt-get install -y python3 python3-apt python3-pip
      changed_when: false

    # パッケージ更新
    - name: パッケージをアップデート
      apt:
        update_cache: yes
        cache_valid_time: 3600
        upgrade: dist
        autoremove: yes
        autoclean: yes
      become: yes

    # 必要パッケージをインストール
    - name: 必要なパッケージをインストール
      apt:
        name:
          - curl
          - wget
          - git
          - vim
          - htop
          - net-tools
          - ntp
          - python3-venv
        state: present
      become: yes

    # タイムゾーン設定
    - name: タイムゾーンを Asia/Tokyo に設定
      timezone:
        name: Asia/Tokyo
      become: yes

    # IP フォワーディング
    - name: IP フォワーディングを有効化
      sysctl:
        name: net.ipv4.ip_forward
        value: "1"
        sysctl_set: yes
        state: present
      become: yes

    # br_netfilter モジュール
    - name: br_netfilter モジュールをロード
      modprobe:
        name: br_netfilter
        state: present
      become: yes
      ignore_errors: yes

    # ブリッジネットワーク設定
    - name: ブリッジネットワーク iptables サポートを有効化
      sysctl:
        name: net.bridge.bridge-nf-call-iptables
        value: "1"
        sysctl_set: yes
        state: present
      become: yes
      ignore_errors: yes

    # /etc/hosts に K3s ドメイン追加
    - name: /etc/hosts に K3s 関連ドメインを追加
      lineinfile:
        path: /etc/hosts
        line: "{{ item }}"
        state: present
      become: yes
      loop:
        - "192.168.0.20 k3s-server-1"
        - "192.168.0.21 k3s-server-2"
        - "192.168.0.22 k3s-server-3"
        - "{{ kube_vip_address }} {{ kube_vip_domain }}"

    # ===================================================================
    # K3sインストール前にkube-vipマニフェストを配置（Serverのみ）
    # K3s が /var/lib/rancher/k3s/server/manifests/ を監視して自動適用
    # 外部ファイル (manifests/kube-vip.yaml) からテンプレート処理して展開
    # ===================================================================
    - name: kube-vip マニフェスト用ディレクトリを作成
      file:
        path: /var/lib/rancher/k3s/server/manifests
        state: directory
        owner: root
        group: root
        mode: '0755'
      become: yes
      when: inventory_hostname in groups['k3s_servers']

    - name: kube-vip マニフェストを配置
      template:
        src: manifests/kube-vip.yaml
        dest: /var/lib/rancher/k3s/server/manifests/kube-vip.yaml
        owner: root
        group: root
        mode: '0600'
      become: yes
      when: inventory_hostname in groups['k3s_servers']

  roles:
    - role: xanmanning.k3s
      become: yes

  post_tasks:

    # K3s 起動確認（Server-1のみ）
    - name: K3s が起動完了するまで待機
      shell: |
        k3s kubectl get nodes
      register: k3s_nodes_ready
      until: k3s_nodes_ready.rc == 0 and k3s_nodes_ready.stdout_lines | length > 0
      retries: 30
      delay: 10
      when: inventory_hostname == "k3s-server-1"

    # kubeconfig 取得（Server-1のみ）
    - name: kubeconfig を取得
      fetch:
        src: /etc/rancher/k3s/k3s.yaml
        dest: ./kubeconfig.yaml
        flat: yes
      become: yes
      when: inventory_hostname == "k3s-server-1"

    # ===================================================================
    # kube-vip Cloud Controller のインストール（Server-1のみ）
    # Service type LoadBalancer を kube-vip で制御するために必要
    # ===================================================================
    - name: kube-vip Cloud Controller をインストール
      shell: |
        kubectl apply -f https://raw.githubusercontent.com/kube-vip/kube-vip-cloud-provider/main/manifest/kube-vip-cloud-controller.yaml
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      become: yes
      when: inventory_hostname == "k3s-server-1"
      ignore_errors: yes

    - name: kube-vip IP レンジを ConfigMap で設定
      shell: |
        kubectl get configmap kubevip -n kube-system >/dev/null 2>&1 && \
        kubectl patch configmap kubevip -n kube-system -p '{"data":{"range-global": "192.168.0.210-192.168.0.219"}}' || \
        kubectl create configmap kubevip -n kube-system --from-literal range-global=192.168.0.210-192.168.0.219
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      become: yes
      when: inventory_hostname == "k3s-server-1"
      register: kubevip_configmap
      changed_when: "'created' in kubevip_configmap.stdout or 'patched' in kubevip_configmap.stdout"
      ignore_errors: yes

    # ================================================
    # デバッグ出力（Role実行後の設定確認）
    # ================================================
    - name: K3s ノード設定を確認
      debug:
        msg: |
          ========================================
          K3s ノード設定確認
          ========================================
          ホスト: {{ inventory_hostname }}
          ノードタイプ: {{ 'Server (Control Plane)' if inventory_hostname in groups['k3s_servers'] else 'Worker' }}
          接続先VIP: {{ kube_vip_address if inventory_hostname in groups['k3s_workers'] else 'N/A (Server)' }}
          k3s_control_node: {{ k3s_control_node }}
          k3s_etcd_datastore: {{ k3s_etcd_datastore }}
          ========================================

    # config.yaml の確認
    - name: config.yaml の内容を表示
      slurp:
        src: /etc/rancher/k3s/config.yaml
      register: k3s_config_raw
      become: yes
      ignore_errors: yes

    - name: 生成された K3s 設定を表示
      debug:
        msg: |
          ========================================
          生成された config.yaml の内容
          ========================================
          {{ k3s_config_raw.content | b64decode }}
          ========================================
      when: k3s_config_raw is not skipped

    # サービスの起動確認
    - name: K3s サービス状態を確認
      shell: |
        {% if inventory_hostname in groups['k3s_servers'] %}
        systemctl status k3s
        {% else %}
        systemctl status k3s-agent
        {% endif %}
      register: k3s_service_status
      changed_when: false
      become: yes
      ignore_errors: yes

    - name: サービス状態を表示
      debug:
        msg: |
          ========================================
          K3s サービス状態（{{ inventory_hostname }}）
          ========================================
          {{ k3s_service_status.stdout_lines[0:3] | join('\n') }}
          ========================================
      when: k3s_service_status.rc == 0


# ==========================================
# ノード数確認（全ノード参加を検証）
# ==========================================
- name: K3s クラスタ ノード確認
  hosts: k3s_servers[0]
  gather_facts: no
  tags:
    - setup
    - k3s

  tasks:
    - name: K3s ノード一覧を取得
      shell: |
        /usr/local/bin/kubectl get nodes -o jsonpath='{.items[*].metadata.name}'
      register: k3s_nodes_list
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      become: yes

    - name: ノード数をカウント
      set_fact:
        k3s_nodes_count: "{{ k3s_nodes_list.stdout.split() | length }}"
        k3s_nodes_names: "{{ k3s_nodes_list.stdout.split() }}"

    - name: 期待されるノード数
      set_fact:
        expected_nodes_count: 5  # 3つのControl Plane + 2つのWorker
        expected_nodes:
          - k3s-server-1
          - k3s-server-2
          - k3s-server-3
          - k3s-worker-1
          - k3s-worker-2

    - name: ノード数の検証
      assert:
        that:
          - k3s_nodes_count | int >= 3  # 最低限サーバーが起動していることを確認
        fail_msg: |
          ❌ K3s クラスタが起動していません
          期待: 最低 3 個以上のノード
          実際: {{ k3s_nodes_count }}個のノード
        success_msg: |
          ✅ K3s クラスタが起動しています
          現在のノード数: {{ k3s_nodes_count }}個
          ノード一覧: {{ k3s_nodes_names | join(', ') }}

    - name: ノードの詳細情報を表示
      shell: |
        /usr/local/bin/kubectl get nodes -o wide
      register: k3s_nodes_detail
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      become: yes

    - name: ノード詳細を出力
      debug:
        msg: |
          {{ k3s_nodes_detail.stdout }}


# ==========================================
# Rancher のインストール (Helm)
# ==========================================
- name: Rancher をデプロイ
  hosts: k3s_servers[0]
  tags:
    - rancher
  become: yes
  vars:
    rancher_domain: "rancher.youkan.uk"
    rancher_version: "v2.13.1"
    cert_manager_version: "v1.15.3"
    rancher_bootstrap_password: "{{ lookup('env', 'RANCHER_PASSWORD') }}"
    ansible_python_interpreter: /usr/bin/python3

  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

  tasks:
    # Python 仮想環境セットアップ
    - name: Python 仮想環境を作成
      shell: |
        python3 -m venv /opt/ansible-venv
      args:
        executable: /bin/bash
      changed_when: false

    - name: 仮想環境に必要なパッケージをインストール
      shell: |
        /opt/ansible-venv/bin/pip install --upgrade pip setuptools wheel
        /opt/ansible-venv/bin/pip install kubernetes>=21.0.0 pyyaml>=5.4.1
      args:
        executable: /bin/bash

    - name: Python インタープリタを仮想環境に設定
      set_fact:
        ansible_python_interpreter: /opt/ansible-venv/bin/python3

    # Helm インストール
    - name: Helm をインストール
      shell: |
        if ! command -v helm >/dev/null 2>&1; then
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
        fi
      args:
        executable: /bin/bash
      changed_when: false

    # Cert-Manager インストール
    - name: Jetstack Helm リポジトリを追加
      kubernetes.core.helm_repository:
        name: jetstack
        repo_url: "https://charts.jetstack.io"
        kubeconfig: /etc/rancher/k3s/k3s.yaml

    - name: Helm リポジトリを更新
      shell: helm repo update
      args:
        executable: /bin/bash
      changed_when: false

    - name: cert-manager をインストール
      kubernetes.core.helm:
        name: cert-manager
        chart_ref: jetstack/cert-manager
        release_namespace: cert-manager
        create_namespace: yes
        chart_version: "{{ cert_manager_version }}"
        values:
          installCRDs: true
        kubeconfig: /etc/rancher/k3s/k3s.yaml
        wait: yes
        wait_timeout: 10m

    # Cert-manager 起動確認
    - name: Cert-manager が起動するまで待機
      shell: |
        kubectl get deployment -n cert-manager cert-manager -o jsonpath='{.status.readyReplicas}' 2>/dev/null || echo 0
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: cert_manager_replicas
      until: cert_manager_replicas.stdout | int > 0
      retries: 30
      delay: 10

    # Rancher インストール
    - name: Rancher Helm リポジトリを追加
      kubernetes.core.helm_repository:
        name: rancher-latest
        repo_url: "https://releases.rancher.com/server-charts/latest"
        kubeconfig: /etc/rancher/k3s/k3s.yaml

    - name: Rancher をインストール
      kubernetes.core.helm:
        name: rancher
        chart_ref: rancher-latest/rancher
        release_namespace: cattle-system
        create_namespace: yes
        chart_version: "{{ rancher_version }}"
        values:
          hostname: "{{ rancher_domain }}"
          replicas: 1
          bootstrapPassword: "{{ rancher_bootstrap_password }}"
          ingress:
            enabled: true
            ingressClassName: traefik
            tls:
              source: letsEncrypt
              certManagerIssuer: letsencrypt-prod
        kubeconfig: /etc/rancher/k3s/k3s.yaml
        wait: yes
        wait_timeout: 15m

    # Rancher 起動確認
    - name: Rancher が起動するまで待機
      shell: |
        kubectl get deployment -n cattle-system rancher -o jsonpath='{.status.readyReplicas}' 2>/dev/null || echo 0
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: rancher_replicas
      until: rancher_replicas.stdout | int > 0
      retries: 30
      delay: 10

    - name: Rancher セットアップ完了
      debug:
        msg: "✓ Rancher は https://{{ rancher_domain }} でアクセス可能です"
