---
# ==========================================
# xanmanning.k3s を使用した K3s クラスタセットアップ
# ==========================================
# 用途:
#   - K3s クラスタを Proxmox VM 上に自動デプロイ
#   - embedded etcd による HA構成（3 ノード）
#   - K3s-server-1 に Rancher を Helm でインストール
#
# 実行方法:
#   ansible-playbook -i inventory.yml playbook-k3s-setup.yml

- name: K3s クラスタセットアップ
  hosts: k3s_servers
  tags:
    - setup
    - k3s
  vars:
    k3s_release_version: false
    k3s_etcd_datastore: true
    k3s_server:
      flannel-backend: vxlan
      audit-log-maxage: 30
      audit-log-maxbackup: 10
      audit-log-maxsize: 100
    k3s_agent:
      node-label:
        - "node-role=worker"
    k3s_skip_validation: false
    ansible_python_interpreter: /usr/bin/python3
  
  pre_tasks:
    # Python ブートストラップ
    - name: Python3 をブートストラップ
      raw: |
        if command -v python3 >/dev/null 2>&1; then
          exit 0
        fi
        sudo apt-get update -y
        sudo apt-get install -y python3 python3-apt python3-pip
      changed_when: false

    # パッケージ更新
    - name: パッケージをアップデート
      apt:
        update_cache: yes
        upgrade: dist
        autoremove: yes
        autoclean: yes
      become: yes

    # 必要パッケージをインストール
    - name: 必要なパッケージをインストール
      apt:
        name:
          - curl
          - wget
          - git
          - vim
          - htop
          - net-tools
          - ntp
          - python3-venv
        state: present
      become: yes

    # タイムゾーン設定
    - name: タイムゾーンを Asia/Tokyo に設定
      timezone:
        name: Asia/Tokyo
      become: yes

    # IP フォワーディング
    - name: IP フォワーディングを有効化
      sysctl:
        name: net.ipv4.ip_forward
        value: "1"
        sysctl_set: yes
        state: present
      become: yes

    # br_netfilter モジュール
    - name: br_netfilter モジュールをロード
      modprobe:
        name: br_netfilter
        state: present
      become: yes
      ignore_errors: yes

    # ブリッジネットワーク設定
    - name: ブリッジネットワーク iptables サポートを有効化
      sysctl:
        name: net.bridge.bridge-nf-call-iptables
        value: "1"
        sysctl_set: yes
        state: present
      become: yes
      ignore_errors: yes

    # /etc/hosts に Rancher ドメイン追加
    - name: /etc/hosts に rancher.youkan.uk を追加
      lineinfile:
        path: /etc/hosts
        line: "192.168.0.20 rancher.youkan.uk"
        state: present
      become: yes

  roles:
    - role: xanmanning.k3s
      become: yes

  post_tasks:
    # K3s 起動確認
    - name: K3s が起動完了するまで待機
      shell: |
        k3s kubectl get nodes
      register: k3s_nodes_ready
      until: k3s_nodes_ready.rc == 0 and k3s_nodes_ready.stdout_lines | length > 0
      retries: 30
      delay: 10
      when: inventory_hostname == "k3s-server-1"

    # kubeconfig 取得
    - name: kubeconfig を取得
      fetch:
        src: /etc/rancher/k3s/k3s.yaml
        dest: ./kubeconfig.yaml
        flat: yes
      become: yes
      when: inventory_hostname == "k3s-server-1"

# ==========================================
# Rancher のインストール (Helm)
# ==========================================
- name: Rancher をデプロイ
  hosts: k3s_servers
  tags:
    - rancher
  become: yes
  vars:
    rancher_domain: "rancher.youkan.uk"
    rancher_version: "v2.12.1"
    cert_manager_version: "v1.15.3"
    rancher_bootstrap_password: "{{ lookup('env', 'RANCHER_PASSWORD') }}"
    ansible_python_interpreter: /usr/bin/python3

  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

  tasks:
    # k3s-server-1 のみで実行
    - name: K3s-server-1 でのみ Rancher をインストール
      block:
        # Python 仮想環境セットアップ
        - name: Python 仮想環境を作成
          shell: |
            python3 -m venv /opt/ansible-venv
          args:
            executable: /bin/bash
          changed_when: false

        - name: 仮想環境に必要なパッケージをインストール
          shell: |
            /opt/ansible-venv/bin/pip install --upgrade pip setuptools wheel
            /opt/ansible-venv/bin/pip install kubernetes>=21.0.0 pyyaml>=5.4.1
          args:
            executable: /bin/bash

        - name: Python インタープリタを仮想環境に設定
          set_fact:
            ansible_python_interpreter: /opt/ansible-venv/bin/python3

        # Helm インストール
        - name: Helm をインストール
          shell: |
            if ! command -v helm >/dev/null 2>&1; then
              curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
            fi
          args:
            executable: /bin/bash
          changed_when: false

        # Cert-Manager インストール
        - name: Jetstack Helm リポジトリを追加
          kubernetes.core.helm_repository:
            name: jetstack
            repo_url: "https://charts.jetstack.io"
            kubeconfig: /etc/rancher/k3s/k3s.yaml

        - name: Helm リポジトリを更新
          shell: helm repo update
          args:
            executable: /bin/bash
          changed_when: false

        - name: cert-manager をインストール
          kubernetes.core.helm:
            name: cert-manager
            chart_ref: jetstack/cert-manager
            release_namespace: cert-manager
            create_namespace: yes
            chart_version: "{{ cert_manager_version }}"
            values:
              installCRDs: true
            kubeconfig: /etc/rancher/k3s/k3s.yaml
            wait: yes
            wait_timeout: 10m

        # Cert-manager 起動確認
        - name: Cert-manager が起動するまで待機
          shell: |
            kubectl get deployment -n cert-manager cert-manager -o jsonpath='{.status.readyReplicas}' 2>/dev/null || echo 0
          environment:
            KUBECONFIG: /etc/rancher/k3s/k3s.yaml
          register: cert_manager_replicas
          until: cert_manager_replicas.stdout | int > 0
          retries: 30
          delay: 10

        # Rancher インストール
        - name: Rancher Helm リポジトリを追加
          kubernetes.core.helm_repository:
            name: rancher-latest
            repo_url: "https://releases.rancher.com/server-charts/latest"
            kubeconfig: /etc/rancher/k3s/k3s.yaml

        - name: Rancher をインストール
          kubernetes.core.helm:
            name: rancher
            chart_ref: rancher-latest/rancher
            release_namespace: cattle-system
            create_namespace: yes
            chart_version: "{{ rancher_version }}"
            values:
              hostname: "{{ rancher_domain }}"
              replicas: 1
              bootstrapPassword: "{{ rancher_bootstrap_password }}"
              ingress:
                enabled: true
                ingressClassName: traefik
                tls:
                  source: letsEncrypt
                  certManagerIssuer: letsencrypt-prod
            kubeconfig: /etc/rancher/k3s/k3s.yaml
            wait: yes
            wait_timeout: 15m

        # Rancher 起動確認
        - name: Rancher が起動するまで待機
          shell: |
            kubectl get deployment -n cattle-system rancher -o jsonpath='{.status.readyReplicas}' 2>/dev/null || echo 0
          environment:
            KUBECONFIG: /etc/rancher/k3s/k3s.yaml
          register: rancher_replicas
          until: rancher_replicas.stdout | int > 0
          retries: 30
          delay: 10

        - name: Rancher セットアップ完了
          debug:
            msg: "✓ Rancher は https://{{ rancher_domain }} でアクセス可能です"

      when: inventory_hostname == "k3s-server-1"
