---
# ==========================================
# xanmanning.k3s を使用した K3s クラスタセットアップ
# ==========================================
# 用途:
#   - K3s クラスタを Proxmox VM 上に自動デプロイ
#   - embedded etcd による HA構成（3 ノード）
#   - Rancher 管理サーバーを別途デプロイ可能
#
# 実行方法:
#   ansible-playbook -i inventory.ini playbook-k3s-setup.yml -v

- name: K3s クラスタセットアップ
  hosts: k3s_servers
  vars:
    # K3s リリース版（false で最新安定版を使用）
    k3s_release_version: false
    # HA クラスタ用 embedded etcd 有効化
    k3s_etcd_datastore: true
    # K3s サーバー設定（制御プレーン）
    k3s_server:
      # デフォルトコンポーネント無効化
      disable:
        - servicelb
        - traefik
      # Flannel バックエンド設定
      flannel-backend: vxlan
      # API サーバー監査ログ設定
      audit-log-maxage: 30
      audit-log-maxbackup: 10
      audit-log-maxsize: 100
    # K3s エージェント設定（ワーカー）
    k3s_agent:
      # ノードラベル
      node-label:
        - "node-role=worker"
    # バリデーション処理をスキップ（必要に応じて）
    k3s_skip_validation: false
    # Python 3 インタープリタパス
    ansible_python_interpreter: /usr/bin/python3
  
  pre_tasks:
    # Python がない場合はインストール
    - name: Python がない場合はブートストラップ
      raw: |
        if command -v python3 >/dev/null 2>&1; then
          exit 0
        fi
        sudo apt-get update -y
        sudo apt-get install -y python3 python3-apt python3-pip
      changed_when: false

    # APT キャッシュ更新とパッケージ更新
    - name: APT キャッシュ更新とディストリビューション更新
      apt:
        update_cache: yes
        upgrade: dist
        autoremove: yes
        autoclean: yes
      become: yes

    # 必要なパッケージをインストール
    - name: 必要なパッケージをインストール
      apt:
        name:
          - curl
          - wget
          - git
          - vim
          - htop
          - net-tools
          - ntp
        state: present
      become: yes

    # タイムゾーンを Asia/Tokyo に設定
    - name: タイムゾーンを Asia/Tokyo に設定
      timezone:
        name: Asia/Tokyo
      become: yes

    # IP フォワーディング有効化
    - name: IP フォワーディング有効化
      sysctl:
        name: net.ipv4.ip_forward
        value: "1"
        sysctl_set: yes
        state: present
      become: yes

    # ブリッジネットワーク設定有効化
    - name: ブリッジネットワーク設定有効化
      sysctl:
        name: net.bridge.bridge-nf-call-iptables
        value: "1"
        sysctl_set: yes
        state: present
      become: yes

    # k3s-server-1 を制御ノードに設定
    - name: k3s-server-1 を制御ノードに設定
      set_fact:
        k3s_control_node: true
      when: inventory_hostname == "k3s-server-1"

  roles:
    - role: xanmanning.k3s
      become: yes

  post_tasks:
    # K3s が起動完了するまで待機
    - name: K3s が起動完了するまで待機
      shell: |
        k3s kubectl get nodes
      register: k3s_nodes_ready
      until: k3s_nodes_ready.rc == 0 and k3s_nodes_ready.stdout_lines | length > 0
      retries: 30
      delay: 10
      check_mode: false
      when: k3s_control_node is defined and k3s_control_node

    # 制御ノードから kubeconfig を取得
    - name: 制御ノードから kubeconfig を取得
      fetch:
        src: /etc/rancher/k3s/k3s.yaml
        dest: ./kubeconfig.yaml
        flat: yes
      become: yes
      check_mode: false
      when: inventory_hostname == "k3s-server-1"

- name: Rancher サーバーセットアップ
  hosts: rancher_servers
  vars:
    # K3s リリース版（false で最新安定版を使用）
    k3s_release_version: false
    # 単一ノードクラスタ（クラスタリング無効）
    k3s_build_cluster: false
    # K3s サーバー設定
    k3s_server:
      # デフォルトコンポーネント無効化
      disable:
        - servicelb
        - traefik
    # Python 3 インタープリタパス
    ansible_python_interpreter: /usr/bin/python3
  
  pre_tasks:
    # Python がない場合はインストール
    - name: Python がない場合はブートストラップ
      raw: |
        if command -v python3 >/dev/null 2>&1; then
          exit 0
        fi
        sudo apt-get update -y
        sudo apt-get install -y python3 python3-apt python3-pip
      changed_when: false

    # APT キャッシュ更新とパッケージ更新
    - name: APT キャッシュ更新とディストリビューション更新
      apt:
        update_cache: yes
        upgrade: dist
        autoremove: yes
        autoclean: yes
      become: yes

    # 必要なパッケージをインストール（Docker 含む）
    - name: 必要なパッケージをインストール
      apt:
        name:
          - curl
          - wget
          - git
          - vim
          - htop
          - net-tools
          - ntp
          - containerd
        state: present
      become: yes

    # タイムゾーンを Asia/Tokyo に設定
    - name: タイムゾーンを Asia/Tokyo に設定
      timezone:
        name: Asia/Tokyo
      become: yes

    # containerd サービスを開始・有効化
    - name: containerd サービスを開始・有効化
      systemd:
        name: containerd
        enabled: yes
        state: started
      become: yes

    # IP フォワーディング有効化
    - name: IP フォワーディング有効化
      sysctl:
        name: net.ipv4.ip_forward
        value: "1"
        sysctl_set: yes
        state: present
      become: yes

    # ブリッジネットワーク設定有効化
    - name: ブリッジネットワーク設定有効化
      sysctl:
        name: net.bridge.bridge-nf-call-iptables
        value: "1"
        sysctl_set: yes
        state: present
      become: yes

    # Rancher を制御ノードに設定
    - name: Rancher を制御ノードに設定
      set_fact:
        k3s_control_node: true

  roles:
    - role: xanmanning.k3s
      become: yes

  post_tasks:
    # K3s が起動完了するまで待機
    - name: K3s が起動完了するまで待機
      shell: |
        k3s kubectl get nodes
      register: k3s_rancher_ready
      until: k3s_rancher_ready.rc == 0
      retries: 30
      delay: 10
      check_mode: false
