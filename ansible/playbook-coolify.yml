---
- name: Coolify PaaS Platform セットアップ
  hosts: coolify
  become: yes
  gather_facts: yes

  tasks:
    # 基本パッケージ更新
    - name: パッケージキャッシュを更新
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: 必要なパッケージをインストール
      apt:
        name:
          - curl
          - ca-certificates
          - gnupg
          - lsb-release
          - apt-transport-https
          - software-properties-common
        state: present

    # Docker インストール
    - name: Docker GPGキーを追加
      shell: |
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
      args:
        creates: /usr/share/keyrings/docker-archive-keyring.gpg

    - name: Docker リポジトリを追加
      shell: |
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

    - name: パッケージキャッシュを再更新
      apt:
        update_cache: yes

    - name: Docker をインストール
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present

    - name: Dockerサービスを開始
      service:
        name: docker
        state: started
        enabled: yes

    # Coolify インストール
    - name: Coolifyをインストール
      shell: curl -fsSL https://get.coolify.io | bash
      register: coolify_install
      changed_when: false

    - name: インストール結果をログに記録
      copy:
        content: "{{ coolify_install.stdout }}\n{{ coolify_install.stderr }}"
        dest: /var/log/coolify-install.log
      when: coolify_install is defined

    # ファイアウォール設定（Cloudflare Tunnel使用のため不要だが、参考）
    - name: UFWを無効化（Cloudflare Tunnel使用）
      shell: ufw disable
      ignore_errors: yes

    # 確認
    - name: Docker のバージョン確認
      shell: docker --version
      register: docker_version
      changed_when: false

    - name: Docker バージョン表示
      debug:
        msg: "{{ docker_version.stdout }}"

    - name: Coolify が起動しているか確認
      shell: docker ps | grep -i coolify || echo "Coolifyはまだ起動していません"
      register: coolify_status
      changed_when: false
      ignore_errors: yes

    - name: Coolify ステータス表示
      debug:
        msg: "{{ coolify_status.stdout_lines }}"
