# ğŸ¯ ãƒ•ãƒ­ãƒ¼å›³è§£

## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¹å‰²åˆ†æ‹…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     home-infra/                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ã€Terraformã‚³ã‚¢ã€‘                                           â”‚
â”‚  â”œâ”€ providers.tf      : ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼è¨­å®š                     â”‚
â”‚  â”œâ”€ variables.tf      : å¤‰æ•°å®šç¾©                            â”‚
â”‚  â””â”€ terraform.tfvars  : å®Ÿéš›ã®å€¤ï¼ˆGitignoreæ¨å¥¨ï¼‰            â”‚
â”‚                                                             â”‚
â”‚  ã€Proxmoxãƒªã‚½ãƒ¼ã‚¹ã€‘                                         â”‚
â”‚  â””â”€ vms.tf            : VM/LXCå®šç¾©                          â”‚
â”‚                         â†“ ä½œæˆ                              â”‚
â”‚                      [Proxmoxã‚¯ãƒ©ã‚¹ã‚¿]                       â”‚
â”‚                                                             â”‚
â”‚  ã€Cloudflareãƒªã‚½ãƒ¼ã‚¹ã€‘                                      â”‚
â”‚  â”œâ”€ tunnel.tf         : Tunnelè¨­å®š                          â”‚
â”‚  â”œâ”€ dns.tf            : DNSãƒ¬ã‚³ãƒ¼ãƒ‰                         â”‚
â”‚  â””â”€ outputs.tf        : å‡ºåŠ›å€¤                              â”‚
â”‚                         â†“ å…¬é–‹                              â”‚
â”‚                      [ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ]                        â”‚
â”‚                                                             â”‚
â”‚  ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€‘                                            â”‚
â”‚  â”œâ”€ README.md         : ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦                     â”‚
â”‚  â”œâ”€ ARCHITECTURE.md   : ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆãƒ•ãƒ­ãƒ¼èª¬æ˜ï¼‰           â”‚
â”‚  â”œâ”€ ADD_SERVICE.md    : ã‚µãƒ¼ãƒ“ã‚¹è¿½åŠ æ‰‹é †                     â”‚
â”‚  â””â”€ SUCCESS_REPORT.md : å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ                        â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ 2ã¤ã®ç‹¬ç«‹ã—ãŸãƒ•ãƒ­ãƒ¼

### ãƒ•ãƒ­ãƒ¼1: VM/LXCä½œæˆï¼ˆProxmoxå´ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  vms.tf     â”‚  ãƒªã‚½ãƒ¼ã‚¹å®šç¾©
â”‚  ç·¨é›†       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ terraform   â”‚  Proxmox APIçµŒç”±ã§ä½œæˆ
â”‚ apply       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Proxmoxã‚¯ãƒ©ã‚¹ã‚¿             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ LXC (VMID 105)      â”‚    â”‚
â”‚  â”‚ IP: 192.168.0.101   â”‚    â”‚
â”‚  â”‚ Port: 80            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ æ‰‹å‹•è¨­å®š
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SSHæ¥ç¶š     â”‚  ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
â”‚ 192.168.0.  â”‚  (Nextcloud, Home Assistantç­‰)
â”‚ 101         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ•ãƒ­ãƒ¼2: ã‚µãƒ¼ãƒ“ã‚¹å…¬é–‹ï¼ˆCloudflareå´ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ terraform.tfvars    â”‚  services{} ã«ã‚¨ãƒ³ãƒˆãƒªè¿½åŠ 
â”‚ ç·¨é›†                â”‚  subdomain, local_urlæŒ‡å®š
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ terraform   â”‚  Cloudflare APIçµŒç”±ã§è¨­å®š
â”‚ apply       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚              â”‚
       â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ tunnel.tf   â”‚  â”‚ dns.tf      â”‚
â”‚ Tunnelè¨­å®š  â”‚  â”‚ CNAMEãƒ¬ã‚³ãƒ¼ãƒ‰â”‚
â”‚ æ›´æ–°        â”‚  â”‚ ä½œæˆ        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚              â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cloudflare Network              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Tunnel: home-tunnel        â”‚  â”‚
â”‚  â”‚ Routes:                    â”‚  â”‚
â”‚  â”‚  pve.youkan.uk             â”‚  â”‚
â”‚  â”‚  â†’ 192.168.0.13:8006       â”‚  â”‚
â”‚  â”‚  cloud.youkan.uk           â”‚  â”‚
â”‚  â”‚  â†’ 192.168.0.101:80        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
        [ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ]
        https://pve.youkan.uk
        https://cloud.youkan.uk
```

## â“ ãªãœåˆ†ã‘ã¦ã„ã‚‹ã®ã‹ï¼Ÿ

### ç†ç”±1: ç‹¬ç«‹æ€§
```
VM/LXCã®ä½œæˆ       â‰     ã‚µãƒ¼ãƒ“ã‚¹ã®å…¬é–‹
  â†“                       â†“
ä¸€åº¦ä½œã£ãŸã‚‰            é »ç¹ã«å¤‰æ›´
ã»ã¼ä¸å¤‰              è¿½åŠ ãƒ»å‰Šé™¤å¤šã„
```

### ç†ç”±2: å®‰å…¨æ€§
```
âŒ çµ±åˆã—ãŸå ´åˆ:
serviceså¤‰æ›´ â†’ terraform apply
             â†’ VMå†ä½œæˆï¼ï¼ï¼ˆãƒ‡ãƒ¼ã‚¿æ¶ˆå¤±ï¼‰

âœ… åˆ†é›¢ã—ãŸå ´åˆ:
serviceså¤‰æ›´ â†’ terraform apply
             â†’ Tunnelè¨­å®šã®ã¿å¤‰æ›´ï¼ˆVMç„¡äº‹ï¼‰
```

### ç†ç”±3: æŸ”è»Ÿæ€§
```
Terraformç®¡ç†ã®LXC        æ‰‹å‹•ä½œæˆã®LXC
     â†“                         â†“
  vms.tf                  (Proxmox UI)
     â†“                         â†“
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
        terraform.tfvars ã«è¿½åŠ 
                 â†“
          ã©ã¡ã‚‰ã‚‚å…¬é–‹å¯èƒ½ï¼
```

## ğŸ¬ å®Ÿéš›ã®ä½¿ç”¨ã‚·ãƒ¼ãƒ³

### ã‚·ãƒ¼ãƒ³1: å®Œå…¨æ–°è¦ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆNextcloudï¼‰

```
1. vms.tf ç·¨é›†
   resource "proxmox_virtual_environment_container" "nextcloud" { ... }

2. terraform apply -target=...nextcloud
   â†’ LXCä½œæˆ (192.168.0.101)

3. ssh root@192.168.0.101
   â†’ Nextcloudã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

4. terraform.tfvars ç·¨é›†
   nextcloud = { subdomain="cloud", local_url="http://192.168.0.101" }

5. terraform apply
   â†’ https://cloud.youkan.uk ã§å…¬é–‹å®Œäº†
```

### ã‚·ãƒ¼ãƒ³2: æ—¢å­˜ã‚µãƒ¼ãƒ“ã‚¹ã‚’å…¬é–‹ï¼ˆHome Assistantï¼‰

```
# ã™ã§ã« VMID 200 ã§ Home AssistantãŒç¨¼åƒä¸­

1. terraform.tfvars ç·¨é›†ã®ã¿
   homeassistant = {
     subdomain = "home"
     local_url = "http://192.168.0.50:8123"
   }

2. terraform apply
   â†’ https://home.youkan.uk ã§å…¬é–‹å®Œäº†

# vms.tfã¯è§¦ã‚‰ãªã„ï¼
```

### ã‚·ãƒ¼ãƒ³3: ã‚µãƒ¼ãƒ“ã‚¹å…¬é–‹ã‚’ä¸€æ™‚åœæ­¢

```
1. terraform.tfvars ã‹ã‚‰ nextcloudè¡Œã‚’å‰Šé™¤

2. terraform apply
   â†’ Tunnelè¨­å®šã¨DNSãƒ¬ã‚³ãƒ¼ãƒ‰å‰Šé™¤
   â†’ LXCã¯ç¨¼åƒç¶™ç¶šï¼ˆ192.168.0.101ã§ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼‰

3. å†å…¬é–‹ã—ãŸã„æ™‚ã¯ terraform.tfvars ã«æˆ»ã™ã ã‘
```

## ğŸ“Š ãƒªã‚½ãƒ¼ã‚¹ã®ä¾å­˜é–¢ä¿‚

```
terraform.tfvars
      â”‚
      â”œâ”€â†’ var.services
      â”‚        â”‚
      â”‚        â”œâ”€â†’ tunnel.tf (tunnelè¨­å®š)
      â”‚        â”‚        â”‚
      â”‚        â”‚        â””â”€â†’ Cloudflare Tunnel
      â”‚        â”‚
      â”‚        â””â”€â†’ dns.tf (CNAMEãƒ¬ã‚³ãƒ¼ãƒ‰)
      â”‚                 â”‚
      â”‚                 â””â”€â†’ Cloudflare DNS
      â”‚
      â”œâ”€â†’ var.proxmox_*
      â”‚        â”‚
      â”‚        â””â”€â†’ providers.tf
      â”‚                 â”‚
      â”‚                 â””â”€â†’ Proxmox API
      â”‚
      â””â”€â†’ vms.tf (LXCå®šç¾©)
               â”‚
               â””â”€â†’ Proxmox ã‚¯ãƒ©ã‚¹ã‚¿

â€» vms.tf ã¨ services{} ã¯ä¾å­˜é–¢ä¿‚ãªã—ï¼
```

## ğŸ“ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### âœ… ã‚„ã‚‹ã¹ãã“ã¨

1. **IPç®¡ç†**: é™çš„IPã‚’ä½¿ç”¨ï¼ˆDHCPä¸å¯ï¼‰
   ```hcl
   ip_config {
     ipv4 {
       address = "192.168.0.101/24"  # å›ºå®šIP
       gateway = "192.168.0.1"
     }
   }
   ```

2. **æ®µéšçš„apply**: targetã‚ªãƒ—ã‚·ãƒ§ãƒ³ä½¿ç”¨
   ```powershell
   terraform apply -target=proxmox_virtual_environment_container.nextcloud
   ```

3. **Gitç®¡ç†**: terraform.tfvarsã¯.gitignore
   ```
   terraform.tfvars   # æ©Ÿå¯†æƒ…å ±å«ã‚€
   terraform.tfvars.example  # ã‚µãƒ³ãƒ—ãƒ«ã¯ã‚³ãƒŸãƒƒãƒˆ
   ```

### âŒ ã‚„ã£ã¦ã¯ã„ã‘ãªã„ã“ã¨

1. **ä¾å­˜é–¢ä¿‚ã®ä½œæˆ**
   ```hcl
   # âŒ æ‚ªã„ä¾‹
   resource "proxmox_virtual_environment_container" "nextcloud" {
     depends_on = [cloudflare_zero_trust_tunnel_cloudflared_config.main]
   }
   ```

2. **å‹•çš„IPå‚ç…§ï¼ˆDHCPï¼‰**
   ```hcl
   # âŒ æ‚ªã„ä¾‹ï¼ˆIPãŒå–å¾—ã§ããªã„ï¼‰
   services = {
     nextcloud = {
       local_url = "http://${proxmox_virtual_environment_container.nextcloud.ipv4}"
     }
   }
   ```

3. **ä¸€æ‹¬å¤‰æ›´**
   ```powershell
   # âŒ å±é™ºï¼ˆã™ã¹ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ã«å½±éŸ¿ï¼‰
   terraform apply

   # âœ… å®‰å…¨ï¼ˆç‰¹å®šãƒªã‚½ãƒ¼ã‚¹ã®ã¿ï¼‰
   terraform apply -target=cloudflare_record.tunnel_cnames
   ```

## ğŸš€ ä»Šå¾Œã®å±•é–‹

### ModuleåŒ–
```
modules/
  â”œâ”€ lxc-service/
  â”‚   â”œâ”€ main.tf
  â”‚   â”œâ”€ variables.tf
  â”‚   â””â”€ outputs.tf
  â””â”€ cloudflare-service/
      â”œâ”€ main.tf
      â””â”€ variables.tf

# ä½¿ç”¨ä¾‹
module "nextcloud" {
  source = "./modules/lxc-service"
  name   = "nextcloud"
  ip     = "192.168.0.101"
}
```

### è‡ªå‹•åŒ–
```yaml
# GitHub Actions
on: [push]
jobs:
  deploy:
    - terraform plan
    - terraform apply -auto-approve
```

---

**ã¾ã¨ã‚**: ãƒ•ãƒ­ãƒ¼1ï¼ˆVMä½œæˆï¼‰ã¨ãƒ•ãƒ­ãƒ¼2ï¼ˆã‚µãƒ¼ãƒ“ã‚¹å…¬é–‹ï¼‰ã‚’åˆ†é›¢ã™ã‚‹ã“ã¨ã§ã€å®‰å…¨ã§æŸ”è»Ÿãªã‚¤ãƒ³ãƒ•ãƒ©ç®¡ç†ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ï¼
